<!doctype html>
<html lang="ko" class="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>사업2팀 고객지원 현황</title>

    <!-- Web App Manifest & Icons for "Add to Home Screen" -->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="SI 사업2팀" />
    <link rel="apple-touch-icon" href="image/logo.jpg" />
    <link rel="icon" type="image/jpeg" href="image/logo.jpg" />
    <meta name="theme-color" content="#102a43" />
    <!-- PWA Manifest with current logo -->
    <link
      rel="manifest"
      href="data:application/manifest+json,%7B%22name%22%3A%22%EC%82%AC%EC%97%852%ED%8C%80%20%EA%B3%A0%EA%B0%9D%EC%A7%80%EC%9B%90%20%ED%98%84%ED%99%A9%22%2C%22short_name%22%3A%22%EA%B3%A0%EA%B0%9D%EC%A7%80%EC%9B%90%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23ffffff%22%2C%22theme_color%22%3A%22%23102a43%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22image%2Flogo.jpg%22%2C%22sizes%22%3A%22192x192%22%2C%22type%22%3A%22image%2Fjpeg%22%7D%2C%7B%22src%22%3A%22image%2Flogo.jpg%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fjpeg%22%7D%5D%7D"
    />

    <!-- Premium Fonts: SUIT (Modern Korean) + Playfair Display (Luxury Serif) -->
    <link
      rel="stylesheet"
      as="style"
      crossorigin
      href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap"
      rel="stylesheet"
    />

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- flatpickr (Advanced Date Picker) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/ko.js"></script>
    <!-- Korean language pack -->
    <!-- Font Awesome for Icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <!-- FullCalendar for Calendar View -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <!-- Showdown.js for Markdown to HTML -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>

    <style>
      /* Premium Luxury Design System */
      :root {
        /* Luxury Color Palette - Deep Navy & Champagne Gold */
        --luxury-navy-50: #f0f4f8;
        --luxury-navy-100: #d9e2ec;
        --luxury-navy-200: #bcccdc;
        --luxury-navy-300: #9fb3c8;
        --luxury-navy-400: #829ab1;
        --luxury-navy-500: #627d98;
        --luxury-navy-600: #486581;
        --luxury-navy-700: #334e68;
        --luxury-navy-800: #243b53;
        --luxury-navy-900: #102a43;
        --luxury-navy-950: #061524;

        /* Champagne Gold Accent */
        --luxury-gold-100: #fdf6e3;
        --luxury-gold-200: #f9e4b7;
        --luxury-gold-300: #f5d28b;
        --luxury-gold-400: #f0c05f;
        --luxury-gold-500: #d4af37;
        --luxury-gold-600: #b8962f;
        --luxury-gold-700: #9c7d28;

        /* Legacy Brand Colors mapped to luxury */
        --primary-50: var(--luxury-navy-50);
        --primary-100: var(--luxury-navy-100);
        --primary-200: var(--luxury-navy-200);
        --primary-300: var(--luxury-navy-300);
        --primary-400: var(--luxury-navy-400);
        --primary-500: var(--luxury-navy-500);
        --primary-600: var(--luxury-navy-600);
        --primary-700: var(--luxury-navy-700);
        --primary-800: var(--luxury-navy-800);
        --primary-900: var(--luxury-navy-900);
        --primary-950: var(--luxury-navy-950);

        /* Premium Background System */
        --bg-color: #fafbfc;
        --card-bg-color: rgba(255, 255, 255, 0.95);
        --text-color: var(--luxury-navy-900);
        --text-muted-color: var(--luxury-navy-600);
        --border-color: rgba(16, 42, 67, 0.08);
        --input-bg-color: #ffffff;
        --input-border-color: rgba(16, 42, 67, 0.15);
        --surface-glass: rgba(255, 255, 255, 0.85);
        --surface-border: rgba(16, 42, 67, 0.1);

        --primary-color: var(--luxury-navy-900);
        --primary-hover-color: var(--luxury-navy-800);
        --accent-color: var(--luxury-gold-500);
        --accent-hover-color: var(--luxury-gold-600);

        /* FullCalendar Custom Properties */
        --fc-border-color: var(--border-color);
        --fc-daygrid-day-bg-color: transparent;
        --fc-list-even-bg-color: var(--bg-color);
        --fc-event-bg-color: var(--primary-color);
        --fc-event-border-color: var(--primary-color);

        /* Premium Shadows */
        --shadow-sm: 0 1px 2px rgba(16, 42, 67, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(16, 42, 67, 0.08), 0 2px 4px -2px rgba(16, 42, 67, 0.04);
        --shadow-lg: 0 10px 15px -3px rgba(16, 42, 67, 0.1), 0 4px 6px -4px rgba(16, 42, 67, 0.05);
        --shadow-xl:
          0 20px 25px -5px rgba(16, 42, 67, 0.12), 0 8px 10px -6px rgba(16, 42, 67, 0.08);
        --shadow-premium: 0 25px 50px -12px rgba(16, 42, 67, 0.25);
        --shadow-gold: 0 4px 20px -2px rgba(212, 175, 55, 0.3);
      }

      html.dark {
        --bg-color: #0a0f1a;
        --card-bg-color: rgba(16, 24, 40, 0.95);
        --text-color: #f8fafc;
        --text-muted-color: var(--luxury-navy-400);
        --border-color: rgba(148, 163, 184, 0.15);
        --input-bg-color: rgba(30, 41, 59, 0.8);
        --input-border-color: rgba(148, 163, 184, 0.2);
        --surface-glass: rgba(16, 24, 40, 0.85);
        --surface-border: rgba(148, 163, 184, 0.2);

        --primary-color: var(--luxury-navy-400);
        --primary-hover-color: var(--luxury-navy-300);
        --accent-color: var(--luxury-gold-400);
        --accent-hover-color: var(--luxury-gold-300);

        /* FullCalendar Dark Mode */
        --fc-border-color: var(--border-color);
        --fc-daygrid-day-bg-color: transparent;
        --fc-list-even-bg-color: var(--bg-color);

        /* Dark Mode Shadows */
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -2px rgba(0, 0, 0, 0.2);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -4px rgba(0, 0, 0, 0.2);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6), 0 8px 10px -6px rgba(0, 0, 0, 0.3);
        --shadow-premium: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
      }

      /* Custom Scrollbar (Low #7) */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: var(--bg-color);
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1; /* gray-300 */
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8; /* gray-400 */
      }
      html.dark ::-webkit-scrollbar-thumb {
        background: #4b5563; /* gray-600 */
      }
      html.dark ::-webkit-scrollbar-thumb:hover {
        background: #6b7280; /* gray-500 */
      }

      body {
        font-family:
          'Pretendard',
          -apple-system,
          BlinkMacSystemFont,
          'Segoe UI',
          sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        transition:
          background-color 0.5s cubic-bezier(0.4, 0, 0.2, 1),
          color 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        min-height: 100vh;
        letter-spacing: -0.01em;
      }

      /* Premium Subtle Grid Background Pattern */
      body::before {
        content: '';
        position: fixed;
        inset: 0;
        z-index: -1;
        background:
          radial-gradient(ellipse 80% 50% at 50% -20%, rgba(212, 175, 55, 0.08), transparent),
          radial-gradient(ellipse 60% 40% at 80% 80%, rgba(16, 42, 67, 0.04), transparent),
          radial-gradient(ellipse 50% 30% at 20% 90%, rgba(212, 175, 55, 0.05), transparent),
          linear-gradient(180deg, #fafbfc 0%, #f5f7fa 50%, #fafbfc 100%);
      }

      html.dark body::before {
        background:
          radial-gradient(ellipse 80% 50% at 50% -20%, rgba(212, 175, 55, 0.06), transparent),
          radial-gradient(ellipse 60% 40% at 80% 80%, rgba(16, 42, 67, 0.5), transparent),
          radial-gradient(ellipse 50% 30% at 20% 90%, rgba(212, 175, 55, 0.04), transparent),
          linear-gradient(180deg, #0a0f1a 0%, #0d1320 50%, #0a0f1a 100%);
      }

      /* Luxury Display Typography */
      .luxury-heading {
        font-family: 'Playfair Display', serif;
        font-weight: 600;
        letter-spacing: -0.02em;
      }

      .luxury-subtitle {
        font-family: 'Playfair Display', serif;
        font-style: italic;
        font-weight: 400;
      }

      /* Premium Luxury Header */
      #mainHeader {
        position: sticky;
        top: 0;
        z-index: 40;
        border-bottom: 1px solid rgba(212, 175, 55, 0.2);
        background: linear-gradient(
          135deg,
          rgba(16, 42, 67, 0.98) 0%,
          rgba(36, 59, 83, 0.96) 50%,
          rgba(16, 42, 67, 0.98) 100%
        );
        backdrop-filter: blur(20px) saturate(180%);
        box-shadow:
          0 4px 6px -1px rgba(16, 42, 67, 0.1),
          0 2px 4px -2px rgba(16, 42, 67, 0.05),
          0 20px 40px -20px rgba(16, 42, 67, 0.3);
      }

      html.dark #mainHeader {
        border-bottom-color: rgba(212, 175, 55, 0.15);
        background: linear-gradient(
          135deg,
          rgba(6, 21, 36, 0.98) 0%,
          rgba(16, 42, 67, 0.96) 50%,
          rgba(6, 21, 36, 0.98) 100%
        );
      }

      /* Gold Accent Line */
      #mainHeader::after {
        content: '';
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        height: 1px;
        background: linear-gradient(
          90deg,
          transparent 0%,
          rgba(212, 175, 55, 0.6) 20%,
          rgba(212, 175, 55, 0.9) 50%,
          rgba(212, 175, 55, 0.6) 80%,
          transparent 100%
        );
        pointer-events: none;
      }

      .header-meta {
        font-size: 0.65rem;
        font-weight: 700;
        letter-spacing: 0.25em;
        text-transform: uppercase;
        color: var(--luxury-gold-400);
        font-family: 'Playfair Display', serif;
      }

      .header-search-wrap {
        position: relative;
      }

      .header-search-wrap::before {
        content: '';
        position: absolute;
        inset: -2px;
        border-radius: 12px;
        background: linear-gradient(135deg, rgba(212, 175, 55, 0.3), rgba(16, 42, 67, 0.1));
        z-index: -1;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .header-search-wrap:focus-within::before {
        opacity: 1;
      }

      .header-search-wrap .form-input {
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.95);
        box-shadow:
          0 4px 6px -1px rgba(16, 42, 67, 0.05),
          inset 0 1px 0 rgba(255, 255, 255, 0.8);
        border-radius: 12px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .header-search-wrap .form-input:focus {
        border-color: var(--luxury-gold-400);
        box-shadow:
          0 0 0 3px rgba(212, 175, 55, 0.15),
          0 4px 12px -2px rgba(16, 42, 67, 0.1);
      }

      html.dark .header-search-wrap .form-input {
        border-color: rgba(255, 255, 255, 0.1);
        background: rgba(16, 24, 40, 0.9);
        color: #f8fafc;
      }

      /* Premium Gold Button */
      #openWorkLogModalButton {
        border-radius: 12px;
        background: linear-gradient(
          135deg,
          var(--luxury-gold-500) 0%,
          var(--luxury-gold-600) 50%,
          var(--luxury-gold-500) 100%
        );
        box-shadow:
          0 4px 14px -4px rgba(212, 175, 55, 0.5),
          0 2px 4px -2px rgba(16, 42, 67, 0.1),
          inset 0 1px 0 rgba(255, 255, 255, 0.3);
        border: 1px solid rgba(212, 175, 55, 0.5);
        font-weight: 600;
        letter-spacing: 0.02em;
        position: relative;
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      #openWorkLogModalButton::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.5s ease;
      }

      #openWorkLogModalButton:hover {
        transform: translateY(-2px);
        box-shadow:
          0 8px 20px -6px rgba(212, 175, 55, 0.6),
          0 4px 6px -2px rgba(16, 42, 67, 0.1);
      }

      #openWorkLogModalButton:hover::before {
        left: 100%;
      }

      #openWorkLogModalButton:active {
        transform: translateY(0);
      }

      /* Premium Card Styling */
      .card {
        background: linear-gradient(
          145deg,
          rgba(255, 255, 255, 0.98) 0%,
          rgba(250, 251, 252, 0.95) 100%
        );
        border-radius: 20px;
        box-shadow:
          var(--shadow-md),
          0 0 0 1px rgba(16, 42, 67, 0.05);
        transition:
          transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1),
          box-shadow 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(20px) saturate(180%);
        position: relative;
        overflow: hidden;
      }

      .card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.3), transparent);
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .card:hover {
        transform: translateY(-4px);
        box-shadow:
          var(--shadow-xl),
          0 0 0 1px rgba(212, 175, 55, 0.1);
      }

      .card:hover::before {
        opacity: 1;
      }

      html.dark .card {
        background: linear-gradient(145deg, rgba(16, 24, 40, 0.95) 0%, rgba(10, 15, 26, 0.98) 100%);
        border-color: rgba(212, 175, 55, 0.1);
      }

      html.dark .card:hover {
        box-shadow:
          var(--shadow-xl),
          0 0 0 1px rgba(212, 175, 55, 0.15),
          0 0 30px -5px rgba(212, 175, 55, 0.1);
      }

      /* Premium UI System */
      #appContainer {
        position: relative;
        isolation: isolate;
      }

      #announcement-banner {
        background: linear-gradient(
          135deg,
          rgba(212, 175, 55, 0.15) 0%,
          rgba(249, 228, 183, 0.2) 100%
        );
        border: 1px solid rgba(212, 175, 55, 0.3);
        box-shadow:
          0 4px 6px -1px rgba(16, 42, 67, 0.05),
          inset 0 1px 0 rgba(255, 255, 255, 0.5);
        border-radius: 16px;
      }

      #listViewContainer,
      #calendarViewContainer,
      #dashboardContainer {
        background: var(--surface-glass);
        border: 1px solid var(--surface-border);
        box-shadow: var(--shadow-lg);
        border-radius: 24px;
      }

      #mainContent h3 {
        letter-spacing: -0.02em;
        font-weight: 700;
      }

      #mainContent h3.luxury-heading {
        font-family: 'Playfair Display', serif;
        font-weight: 600;
        font-size: 1.5rem;
      }

      /* Premium Action Buttons */
      #exportCsvButton,
      #deleteSelectedButton {
        border-radius: 12px;
        box-shadow: var(--shadow-md);
        font-weight: 600;
        letter-spacing: 0.01em;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      #exportCsvButton {
        background: linear-gradient(135deg, var(--luxury-navy-700), var(--luxury-navy-800));
        border: 1px solid rgba(212, 175, 55, 0.2);
      }

      #exportCsvButton:hover {
        background: linear-gradient(135deg, var(--luxury-navy-800), var(--luxury-navy-900));
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
      }

      /* Premium Toggle Container */
      #viewToggleContainer,
      #dashboardToggleContainer {
        border: 1px solid rgba(16, 42, 67, 0.1);
        background: rgba(16, 42, 67, 0.05);
        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.02);
        border-radius: 9999px;
        padding: 4px;
      }

      html.dark #viewToggleContainer,
      html.dark #dashboardToggleContainer {
        background: rgba(16, 42, 67, 0.3);
        border-color: rgba(212, 175, 55, 0.1);
      }

      #listViewToggle,
      #calendarViewToggle,
      #teamDashboardToggle,
      #personalDashboardToggle {
        border-radius: 9999px;
        font-weight: 600;
        padding: 0.5rem 1.25rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 0.875rem;
      }

      #listViewToggle.bg-white,
      #calendarViewToggle.bg-white,
      #teamDashboardToggle.bg-white,
      #personalDashboardToggle.bg-white {
        box-shadow:
          0 4px 6px -1px rgba(16, 42, 67, 0.1),
          0 2px 4px -2px rgba(16, 42, 67, 0.05);
        background: linear-gradient(145deg, #ffffff, #f8fafc);
        color: var(--luxury-navy-900);
      }

      html.dark #listViewToggle.bg-white,
      html.dark #calendarViewToggle.bg-white,
      html.dark #teamDashboardToggle.bg-white,
      html.dark #personalDashboardToggle.bg-white {
        background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(16, 24, 40, 0.95));
        color: #f8fafc;
      }

      /* Premium Table Styling */
      #recordsTableBody tr {
        transition: all 0.2s ease;
      }

      #recordsTableBody tr:hover {
        background: rgba(212, 175, 55, 0.04);
        transform: scale(1.002);
      }

      html.dark #recordsTableBody tr:hover {
        background: rgba(212, 175, 55, 0.08);
      }

      #paginationControls .page-link {
        border-radius: 10px;
        border: 1px solid rgba(16, 42, 67, 0.1);
        transition: all 0.2s ease;
      }

      #paginationControls .page-link:hover {
        border-color: var(--luxury-gold-400);
        color: var(--luxury-navy-800);
      }

      #paginationControls .page-link.active {
        background: linear-gradient(135deg, var(--luxury-navy-800), var(--luxury-navy-900));
        border-color: var(--luxury-gold-400);
        box-shadow: var(--shadow-gold);
      }

      /* Premium Dashboard Container */
      #dashboardContainer {
        position: relative;
        overflow: hidden;
        border-radius: 24px;
      }

      #dashboardContainer::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(
          135deg,
          rgba(212, 175, 55, 0.03) 0%,
          transparent 50%,
          rgba(16, 42, 67, 0.02) 100%
        );
        pointer-events: none;
      }

      /* Ultra Premium Minimal KPI Cards */
      .dashboard-kpi-card {
        position: relative;
        overflow: hidden;
        border-radius: 16px;
        background: #ffffff;
        border: 1px solid rgba(16, 42, 67, 0.06);
        box-shadow: 0 1px 3px rgba(16, 42, 67, 0.04);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        padding: 1.5rem;
      }

      .dashboard-kpi-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px -8px rgba(16, 42, 67, 0.12);
        border-color: rgba(16, 42, 67, 0.1);
      }

      html.dark .dashboard-kpi-card {
        background: rgba(16, 24, 40, 0.6);
        border-color: rgba(255, 255, 255, 0.05);
      }

      html.dark .dashboard-kpi-card:hover {
        border-color: rgba(212, 175, 55, 0.15);
        box-shadow: 0 8px 24px -8px rgba(0, 0, 0, 0.3);
      }

      /* KPI Card Header with Icon and Change Badge */
      .dashboard-kpi-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
      }

      .dashboard-kpi-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.125rem;
      }

      .dashboard-kpi-icon.navy {
        background: rgba(16, 42, 67, 0.08);
        color: var(--luxury-navy-700);
      }

      .dashboard-kpi-icon.gold {
        background: rgba(212, 175, 55, 0.12);
        color: var(--luxury-gold-600);
      }

      .dashboard-kpi-icon.teal {
        background: rgba(13, 148, 136, 0.08);
        color: #0d9488;
      }

      .dashboard-kpi-icon.rose {
        background: rgba(225, 29, 72, 0.08);
        color: #e11d48;
      }

      /* Change Badge */
      .dashboard-kpi-change {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.375rem 0.625rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
      }

      .dashboard-kpi-change.up {
        background: rgba(16, 185, 129, 0.08);
        color: #059669;
      }

      .dashboard-kpi-change.down {
        background: rgba(239, 68, 68, 0.08);
        color: #dc2626;
      }

      .dashboard-kpi-change.neutral {
        background: rgba(100, 116, 139, 0.08);
        color: #64748b;
      }

      /* KPI Label */
      .dashboard-kpi-label {
        font-size: 0.8125rem;
        font-weight: 500;
        color: var(--luxury-navy-500);
        margin-bottom: 0.5rem;
        letter-spacing: -0.01em;
      }

      html.dark .dashboard-kpi-label {
        color: var(--luxury-navy-400);
      }

      /* KPI Value */
      .dashboard-kpi-value {
        font-size: 2rem;
        line-height: 1.2;
        font-weight: 600;
        color: var(--luxury-navy-900);
        letter-spacing: -0.02em;
        font-family:
          'Pretendard',
          -apple-system,
          sans-serif;
      }

      .dashboard-kpi-value .unit {
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--luxury-navy-400);
        margin-left: 0.25rem;
      }

      html.dark .dashboard-kpi-value {
        color: #f8fafc;
      }

      html.dark .dashboard-kpi-value .unit {
        color: var(--luxury-navy-400);
      }

      .dashboard-kpi-card:hover {
        transform: translateY(-6px);
        box-shadow:
          var(--shadow-xl),
          0 0 30px -10px rgba(212, 175, 55, 0.2);
      }

      html.dark .dashboard-kpi-card {
        background: linear-gradient(145deg, rgba(16, 24, 40, 0.95) 0%, rgba(10, 15, 26, 0.9) 100%);
        border-color: rgba(212, 175, 55, 0.2);
      }

      .dashboard-kpi-card::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, transparent, var(--luxury-gold-400), transparent);
        opacity: 0.6;
      }

      .dashboard-kpi-label {
        font-size: 0.75rem;
        letter-spacing: 0.15em;
        text-transform: uppercase;
        font-weight: 700;
        color: var(--luxury-navy-500);
        font-family: 'Playfair Display', serif;
      }

      html.dark .dashboard-kpi-label {
        color: var(--luxury-navy-400);
      }

      .dashboard-kpi-value {
        margin-top: 0.5rem;
        font-size: 2.25rem;
        line-height: 1;
        font-weight: 300;
        color: var(--luxury-navy-900);
        letter-spacing: -0.03em;
        font-family: 'Playfair Display', serif;
      }

      html.dark .dashboard-kpi-value {
        color: #f8fafc;
      }

      /* Premium Chart Panel */
      .dashboard-chart-panel {
        border-radius: 20px;
        border: 1px solid rgba(16, 42, 67, 0.08);
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.95) 0%,
          rgba(250, 251, 252, 0.9) 100%
        );
        box-shadow: var(--shadow-lg);
      }

      html.dark .dashboard-chart-panel {
        border-color: rgba(212, 175, 55, 0.1);
        background: linear-gradient(180deg, rgba(16, 24, 40, 0.95) 0%, rgba(10, 15, 26, 0.9) 100%);
      }

      .dashboard-month-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        border-radius: 9999px;
        padding: 0.4rem 1rem;
        font-size: 0.75rem;
        font-weight: 700;
        letter-spacing: 0.05em;
        color: var(--luxury-navy-800);
        background: linear-gradient(
          135deg,
          rgba(212, 175, 55, 0.2) 0%,
          rgba(249, 228, 183, 0.3) 100%
        );
        border: 1px solid rgba(212, 175, 55, 0.3);
        box-shadow: 0 2px 4px -1px rgba(16, 42, 67, 0.05);
      }

      html.dark .dashboard-month-badge {
        color: var(--luxury-gold-300);
        background: linear-gradient(
          135deg,
          rgba(212, 175, 55, 0.15) 0%,
          rgba(212, 175, 55, 0.05) 100%
        );
        border-color: rgba(212, 175, 55, 0.25);
      }

      /* Premium Form Inputs */
      .form-input,
      .form-select,
      .form-textarea {
        background-color: var(--input-bg-color);
        border: 1.5px solid var(--input-border-color);
        color: var(--text-color);
        border-radius: 12px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 0.9375rem;
      }

      .form-input:hover,
      .form-select:hover,
      .form-textarea:hover {
        border-color: rgba(16, 42, 67, 0.25);
      }

      .form-input:focus,
      .form-select:focus,
      .form-textarea:focus {
        border-color: var(--luxury-gold-400);
        box-shadow:
          0 0 0 4px rgba(212, 175, 55, 0.1),
          0 4px 12px -4px rgba(16, 42, 67, 0.1);
        outline: none;
      }

      .form-input::placeholder {
        color: var(--luxury-navy-400);
        opacity: 0.7;
      }

      .form-input.is-invalid,
      .form-select.is-invalid,
      .form-textarea.is-invalid {
        border-color: #dc2626;
        box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
      }

      .form-error-message {
        color: #dc2626;
        font-size: 0.8125rem;
        margin-top: 0.375rem;
        font-weight: 500;
      }

      /* Premium Modal Styling */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(6, 21, 36, 0.6);
        backdrop-filter: blur(8px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9998;
        transition: opacity 0.3s ease;
      }

      .modal-content {
        background: linear-gradient(
          145deg,
          rgba(255, 255, 255, 0.98) 0%,
          rgba(250, 251, 252, 0.95) 100%
        );
        padding: 2rem;
        border-radius: 24px;
        max-width: 90%;
        width: 500px;
        position: absolute;
        box-shadow:
          var(--shadow-premium),
          0 0 0 1px rgba(212, 175, 55, 0.1) inset;
        border: 1px solid rgba(212, 175, 55, 0.15);
      }

      html.dark .modal-content {
        background: linear-gradient(145deg, rgba(16, 24, 40, 0.98) 0%, rgba(10, 15, 26, 0.95) 100%);
        border-color: rgba(212, 175, 55, 0.2);
      }

      .modal-header {
        cursor: move;
        padding-bottom: 1.25rem;
        border-bottom: 1px solid rgba(16, 42, 67, 0.08);
        margin-bottom: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-header h3 {
        font-family: 'Playfair Display', serif;
        font-weight: 600;
        font-size: 1.5rem;
        color: var(--luxury-navy-900);
      }

      html.dark .modal-header h3 {
        color: #f8fafc;
      }

      .modal-body {
        padding: 0;
      }

      /* Ensure secondary modals appear on top of the primary ones */
      #templateModal,
      #profileModal,
      #userManagementModal,
      #eventDetailModal,
      #editUserModal {
        z-index: 9999;
      }

      /* 템플릿 삭제 확인 모달의 z-index를 가장 높게 설정 */
      #confirmModal {
        z-index: 10000;
      }

      /* FullCalendar popover styling for dark mode visibility (개선) */
      .fc-popover {
        z-index: 9999 !important; /* 팝오버는 모달보다 낮게 설정 */
        background-color: var(--card-bg-color) !important;
        border-color: var(--border-color) !important;
        box-shadow:
          0 4px 6px -1px rgb(0 0 0 / 0.1),
          0 2px 4px -2px rgb(0 0 0 / 0.1) !important;
        color: var(--text-color) !important;

        /* 추가: 팝오버 내용이 너무 길어 겹치는 현상 방지 */
        max-width: 300px; /* 팝오버의 최대 너비 설정 (필요에 따라 조정) */
        word-break: break-word; /* 긴 단어가 잘리지 않고 줄 바꿈되도록 설정 */
        overflow-y: auto; /* 내용이 많을 경우 스크롤바 표시 */
        max-height: 80vh; /* 팝오버의 최대 높이 설정 (화면 높이에 따라 조정) */
      }

      .fc-popover .fc-popover-header {
        background-color: var(--bg-color) !important;
        border-color: var(--border-color) !important;
        color: var(--text-color) !important;
      }

      .fc-popover-title,
      .fc-popover-close {
        color: var(--text-color) !important;
      }

      /* Micro-interactions (Medium #6) */

      /* Ripple Effect */
      .ripple {
        position: absolute;
        border-radius: 50%;
        transform: scale(0);
        animation: ripple 0.6s linear;
        background-color: rgba(255, 255, 255, 0.3);
        pointer-events: none;
      }
      @keyframes ripple {
        to {
          transform: scale(4);
          opacity: 0;
        }
      }
      .interactive-button {
        position: relative;
        overflow: hidden;
      }

      /* Enhanced Modal Animation */
      .modal-overlay {
        transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        backdrop-filter: blur(4px); /* Added blur effect */
      }
      .modal-content {
        transform: scale(0.9) translateY(10px);
        opacity: 0;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); /* Bouncy effect */
      }
      .modal-overlay:not(.hidden) .modal-content {
        transform: scale(1) translateY(0);
        opacity: 1;
      }

      /* Skeleton Pulse Enhancement */
      .skeleton {
        background: linear-gradient(
          90deg,
          var(--border-color) 25%,
          var(--bg-color) 50%,
          var(--border-color) 75%
        );
        background-size: 200% 100%;
        animation: skeleton-loading 1.5s infinite;
      }
      @keyframes skeleton-loading {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }

      /* Mobile Responsive Table (Critical #1) */
      @media (max-width: 768px) {
        #mainHeader {
          padding: 0.9rem 1rem;
        }
        .header-meta {
          display: none;
        }
        .dashboard-kpi-value {
          font-size: 1.75rem;
        }
        .responsive-table thead {
          display: none;
        }
        .responsive-table tr {
          display: block;
          background-color: var(--card-bg-color);
          border-radius: 0.75rem;
          box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
          margin-bottom: 1.5rem; /* Increased spacing between cards */
          padding: 1.5rem; /* p-6 equivalent */
          border: 1px solid var(--border-color);
        }
        .responsive-table tr:last-child {
          margin-bottom: 0;
        }
        .responsive-table td {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 0.75rem 0; /* Increased vertical padding for touch targets */
          border-bottom: 1px solid var(--border-color);
          min-height: 44px; /* Minimum touch target size */
        }
        .responsive-table td:last-child {
          border-bottom: none;
          padding-bottom: 0;
          padding-top: 1rem;
          margin-top: 0.5rem;
        }
        .responsive-table td::before {
          content: attr(data-label);
          font-weight: 600;
          margin-right: 1rem;
          color: var(--text-muted-color);
          font-size: 0.875rem;
        }
        .responsive-table td.actions-cell {
          justify-content: flex-end;
          gap: 0.75rem;
        }
        /* On mobile, the inner div with buttons should take up the available space */
        .responsive-table td.actions-cell > div {
          flex-grow: 1;
          display: flex;
          justify-content: flex-end;
          gap: 0.5rem;
        }
        /* Make buttons larger on mobile */
        .responsive-table .action-btn {
          padding: 0.5rem 1rem;
          font-size: 0.875rem;
        }
      }

      /* Premium Toast Notifications */
      #toastContainer {
        position: fixed;
        top: 1.5rem;
        right: 1.5rem;
        z-index: 2000;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .toast {
        padding: 1rem 1.5rem;
        border-radius: 16px;
        box-shadow:
          var(--shadow-lg),
          0 0 0 1px rgba(255, 255, 255, 0.1) inset;
        color: white;
        opacity: 0;
        transform: translateX(100%) scale(0.95);
        animation: premiumSlideIn 4.5s forwards;
        backdrop-filter: blur(20px);
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        max-width: 400px;
      }

      .toast::before {
        font-family: 'Font Awesome 6 Free';
        font-weight: 900;
        font-size: 1.25rem;
      }

      .toast.success {
        background: linear-gradient(
          135deg,
          rgba(22, 101, 52, 0.95) 0%,
          rgba(20, 83, 45, 0.95) 100%
        );
        border: 1px solid rgba(74, 222, 128, 0.3);
      }

      .toast.success::before {
        content: '\f00c';
        color: #4ade80;
      }

      .toast.error {
        background: linear-gradient(
          135deg,
          rgba(153, 27, 27, 0.95) 0%,
          rgba(127, 29, 29, 0.95) 100%
        );
        border: 1px solid rgba(252, 165, 165, 0.3);
      }

      .toast.error::before {
        content: '\f071';
        color: #fca5a5;
      }

      .toast.info {
        background: linear-gradient(135deg, var(--luxury-navy-800) 0%, var(--luxury-navy-900) 100%);
        border: 1px solid rgba(212, 175, 55, 0.3);
      }

      .toast.info::before {
        content: '\f129';
        color: var(--luxury-gold-400);
      }

      @keyframes premiumSlideIn {
        0% {
          opacity: 0;
          transform: translateX(100%) scale(0.95);
        }
        8% {
          opacity: 1;
          transform: translateX(0) scale(1);
        }
        92% {
          opacity: 1;
          transform: translateX(0) scale(1);
        }
        100% {
          opacity: 0;
          transform: translateX(100%) scale(0.95);
        }
      }

      /* Premium FullCalendar Customizations */
      .fc .fc-toolbar-title {
        font-size: 1.375rem;
        color: var(--text-color);
        font-family: 'Playfair Display', serif;
        font-weight: 600;
        letter-spacing: -0.02em;
      }

      .fc .fc-button-primary {
        background: linear-gradient(135deg, var(--luxury-navy-800), var(--luxury-navy-900));
        border: 1px solid rgba(212, 175, 55, 0.3);
        box-shadow: var(--shadow-sm);
        transition: all 0.3s ease;
        border-radius: 10px;
        font-weight: 600;
      }

      .fc .fc-button-primary:hover {
        background: linear-gradient(135deg, var(--luxury-navy-900), var(--luxury-navy-950));
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
      }

      .fc-daygrid-day-number,
      .fc-col-header-cell-cushion {
        color: var(--text-muted-color);
        font-weight: 500;
      }

      .fc-day-today {
        background: linear-gradient(
          135deg,
          rgba(212, 175, 55, 0.1) 0%,
          rgba(249, 228, 183, 0.15) 100%
        ) !important;
        border: 1px solid rgba(212, 175, 55, 0.2) !important;
      }

      .fc-event {
        cursor: pointer;
        border-radius: 8px;
        box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
        transition:
          transform 0.2s ease,
          box-shadow 0.2s ease;
      }

      .fc-event:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px -2px rgba(0, 0, 0, 0.15);
      }

      .fc-event .fc-event-main-frame {
        align-items: center;
        overflow: hidden;
        word-break: break-all;
      }

      /* Calendar Day Colors: Sunday=Red, Saturday=Blue */
      .fc-day-sun .fc-daygrid-day-number,
      .fc-day-sun .fc-col-header-cell-cushion {
        color: #dc2626 !important;
        font-weight: 600;
      }

      .fc-day-sat .fc-daygrid-day-number,
      .fc-day-sat .fc-col-header-cell-cushion {
        color: #2563eb !important;
        font-weight: 600;
      }

      /* Holiday text color (red) - All holiday events */
      .fc-event.holiday-event,
      .fc-event.holiday-event .fc-event-main,
      .fc-event.holiday-event .fc-event-title,
      .fc-daygrid-event.holiday-event,
      .fc-list-event.holiday-event {
        color: #dc2626 !important;
        font-weight: 700 !important;
        background: transparent !important;
        border-color: transparent !important;
        box-shadow: none !important;
      }

      .fc-event.holiday-event .fc-event-main-frame {
        color: #dc2626 !important;
        font-weight: 700 !important;
      }

      /* Premium User Icon on Calendar */
      .user-initial-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 1.5rem;
        height: 1.5rem;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--luxury-gold-500), var(--luxury-gold-600));
        color: var(--luxury-navy-900);
        font-size: 0.6875rem;
        font-weight: 700;
        flex-shrink: 0;
        margin-right: 0.5rem;
        box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
      }

      .fc-event-main-frame {
        align-items: center;
      }

      /* Premium Calendar Grid */
      .fc-theme-standard .fc-scrollgrid {
        border-color: rgba(16, 42, 67, 0.08);
      }

      .fc-theme-standard td,
      .fc-theme-standard th {
        border-color: rgba(16, 42, 67, 0.06);
      }

      html.dark .fc-theme-standard .fc-scrollgrid,
      html.dark .fc-theme-standard td,
      html.dark .fc-theme-standard th {
        border-color: rgba(212, 175, 55, 0.1);
      }

      /* Dashboard Month Filter Ultra Minimal Styling */
      #dashboardMonthFilter {
        background: #ffffff;
        border: 1px solid rgba(16, 42, 67, 0.08);
        border-radius: 10px;
        padding: 0.625rem 1rem;
        font-weight: 500;
        font-size: 0.9375rem;
        color: var(--luxury-navy-800);
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 160px;
      }

      #dashboardMonthFilter:hover {
        border-color: rgba(16, 42, 67, 0.15);
        background: #fafafa;
      }

      #dashboardMonthFilter:focus {
        border-color: rgba(16, 42, 67, 0.2);
        outline: none;
      }

      html.dark #dashboardMonthFilter {
        background: rgba(16, 24, 40, 0.6);
        border-color: rgba(255, 255, 255, 0.08);
        color: #f8fafc;
      }

      html.dark #dashboardMonthFilter:hover {
        background: rgba(16, 24, 40, 0.8);
        border-color: rgba(255, 255, 255, 0.12);
      }

      /* My Records Filter Premium Styling */
      #myRecordsFilterContainer {
        display: flex;
        align-items: center;
        padding: 0.5rem 1rem;
        background: rgba(255, 255, 255, 0.6);
        border: 1px solid rgba(16, 42, 67, 0.08);
        border-radius: 9999px;
        transition: all 0.3s ease;
      }

      #myRecordsFilterContainer:hover {
        background: rgba(255, 255, 255, 0.9);
        border-color: rgba(212, 175, 55, 0.3);
      }

      #myRecordsFilter {
        appearance: none;
        width: 1.25rem;
        height: 1.25rem;
        border: 2px solid var(--luxury-navy-400);
        border-radius: 4px;
        background: transparent;
        cursor: pointer;
        position: relative;
        transition: all 0.2s ease;
      }

      #myRecordsFilter:checked {
        background: var(--luxury-gold-500);
        border-color: var(--luxury-gold-500);
      }

      #myRecordsFilter:checked::after {
        content: '';
        position: absolute;
        left: 4px;
        top: 1px;
        width: 5px;
        height: 9px;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
      }

      #myRecordsFilter + label {
        margin-left: 0.5rem;
        font-weight: 500;
        color: var(--luxury-navy-700);
        cursor: pointer;
      }

      /* Premium Entrance Animations */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes fadeInScale {
        from {
          opacity: 0;
          transform: scale(0.95);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      @keyframes shimmer {
        0% {
          background-position: -200% 0;
        }
        100% {
          background-position: 200% 0;
        }
      }

      .animate-fade-in-up {
        animation: fadeInUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
      }

      .animate-fade-in-scale {
        animation: fadeInScale 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
      }

      /* Stagger children animations */
      .stagger-children > * {
        opacity: 0;
        animation: fadeInUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
      }

      .stagger-children > *:nth-child(1) {
        animation-delay: 0.1s;
      }
      .stagger-children > *:nth-child(2) {
        animation-delay: 0.2s;
      }
      .stagger-children > *:nth-child(3) {
        animation-delay: 0.3s;
      }
      .stagger-children > *:nth-child(4) {
        animation-delay: 0.4s;
      }
      .stagger-children > *:nth-child(5) {
        animation-delay: 0.5s;
      }

      /* Premium Button Interactions */
      .interactive-button {
        position: relative;
        overflow: hidden;
        transition:
          transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1),
          box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .interactive-button::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.6s ease;
      }

      .interactive-button:hover {
        transform: translateY(-3px);
        box-shadow:
          0 8px 16px -4px rgba(16, 42, 67, 0.15),
          0 4px 6px -2px rgba(16, 42, 67, 0.05);
      }

      .interactive-button:hover::before {
        left: 100%;
      }

      .interactive-button:active {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px -2px rgba(16, 42, 67, 0.1);
      }

      /* Premium Submit Button */
      #submitButton {
        background: linear-gradient(
          135deg,
          var(--luxury-navy-800) 0%,
          var(--luxury-navy-900) 50%,
          var(--luxury-navy-800) 100%
        ) !important;
        border: 1px solid rgba(212, 175, 55, 0.3) !important;
        box-shadow:
          0 4px 14px -4px rgba(16, 42, 67, 0.4),
          inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
      }

      #submitButton:hover {
        box-shadow:
          0 8px 20px -6px rgba(16, 42, 67, 0.5),
          0 0 20px -5px rgba(212, 175, 55, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.15) !important;
      }

      /* Premium Auth Modal Specific Styles */
      #authModal .modal-content,
      #signupModal .modal-content {
        background: linear-gradient(
          165deg,
          rgba(255, 255, 255, 0.98) 0%,
          rgba(250, 251, 252, 0.95) 50%,
          rgba(255, 255, 255, 0.98) 100%
        );
        border: 1px solid rgba(212, 175, 55, 0.2);
        box-shadow:
          0 25px 50px -12px rgba(16, 42, 67, 0.25),
          0 0 0 1px rgba(255, 255, 255, 0.5) inset;
        padding: 2.5rem;
      }

      html.dark #authModal .modal-content,
      html.dark #signupModal .modal-content {
        background: linear-gradient(
          165deg,
          rgba(16, 24, 40, 0.98) 0%,
          rgba(10, 15, 26, 0.95) 50%,
          rgba(16, 24, 40, 0.98) 100%
        );
        border-color: rgba(212, 175, 55, 0.25);
      }

      #authModal .app-logo,
      #signupModal .app-logo {
        filter: drop-shadow(0 4px 6px rgba(16, 42, 67, 0.1));
        transition: transform 0.3s ease;
      }

      #authModal .app-logo:hover,
      #signupModal .app-logo:hover {
        transform: scale(1.05);
      }

      #authModal .form-input,
      #signupModal .form-input {
        border: 1.5px solid rgba(16, 42, 67, 0.12);
        background: rgba(255, 255, 255, 0.9);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      #authModal .form-input:focus,
      #signupModal .form-input:focus {
        border-color: var(--luxury-gold-400);
        box-shadow:
          0 0 0 4px rgba(212, 175, 55, 0.1),
          0 4px 12px -4px rgba(16, 42, 67, 0.1);
        background: #ffffff;
      }

      html.dark #authModal .form-input,
      html.dark #signupModal .form-input {
        background: rgba(30, 41, 59, 0.8);
        border-color: rgba(255, 255, 255, 0.1);
      }

      /* Premium Admin Modal Tabs */
      .tab-button {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-bottom: 2px solid transparent;
        padding: 0.75rem 1.25rem;
        font-weight: 500;
        color: var(--text-muted-color);
        position: relative;
      }

      .tab-button:hover {
        color: var(--luxury-navy-700);
      }

      .tab-button.active {
        border-bottom-color: var(--luxury-gold-500);
        color: var(--luxury-navy-900);
        font-weight: 600;
      }

      html.dark .tab-button.active {
        color: var(--luxury-gold-400);
      }

      .tab-button.active::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 50%;
        transform: translateX(-50%);
        width: 30%;
        height: 2px;
        background: linear-gradient(90deg, transparent, var(--luxury-gold-400), transparent);
      }

      .tab-content {
        display: none;
        animation: fadeIn 0.3s ease;
      }

      .tab-content.active {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* User Management Specific Styles */
      .user-management-actions {
        white-space: nowrap;
        display: flex;
        align-items: center;
      }

      /* Options Management Specific Styles */
      #adminOptionsTab .flex-gap-2 {
        display: flex;
        align-items: stretch;
        gap: 0.5rem;
      }
      #adminOptionsTab .flex-gap-2 > .form-input {
        flex-grow: 1;
        min-width: 0; /* Ensures the input can shrink */
      }
      #adminOptionsTab .flex-gap-2 > button {
        flex-shrink: 0;
      }

      /* Premium Toggle Switch */
      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 48px;
        height: 26px;
      }

      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #cbd5e1, #94a3b8);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 26px;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .slider:before {
        position: absolute;
        content: '';
        height: 20px;
        width: 20px;
        left: 3px;
        bottom: 3px;
        background: linear-gradient(145deg, #ffffff, #f1f5f9);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
      }

      input:checked + .slider {
        background: linear-gradient(135deg, var(--luxury-gold-500), var(--luxury-gold-600));
        box-shadow:
          inset 0 2px 4px rgba(0, 0, 0, 0.1),
          0 0 10px rgba(212, 175, 55, 0.3);
      }

      input:checked + .slider:before {
        transform: translateX(22px);
        background: linear-gradient(145deg, #ffffff, #fefce8);
      }

      .toggle-switch:hover .slider {
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15);
      }

      /* Pagination Styles */
      .page-link {
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border-color);
        background-color: var(--card-bg-color);
        color: var(--text-muted-color);
        border-radius: 0.375rem;
        cursor: pointer;
        transition: all 0.2s;
      }
      .page-link:hover {
        background-color: var(--bg-color);
        border-color: var(--primary-color);
      }
      .page-link.active {
        background-color: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
        font-weight: 600;
      }
      .page-link.disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .page-ellipsis {
        padding: 0.5rem 0.25rem;
        color: var(--text-muted-color);
      }
    </style>
  </head>
  <body class="min-h-screen flex flex-col">
    <div id="toastContainer"></div>

    <button
      type="button"
      id="darkModeToggle"
      class="fixed top-4 right-4 z-50 w-12 h-12 flex items-center justify-center rounded-full bg-white/90 dark:bg-slate-800/90 text-luxury-navy-800 dark:text-luxury-gold-400 shadow-lg border border-luxury-navy-200/50 dark:border-luxury-gold-400/20 backdrop-blur-md transition-all duration-300 interactive-button hover:shadow-xl hover:scale-105"
      style="--luxury-navy-800: #243b53; --luxury-navy-200: #bcccdc; --luxury-gold-400: #f0c05f"
    >
      <i class="fas fa-moon"></i>
    </button>

    <!-- Confirm Modal (미리 정의된 모달로 변경) -->
    <div id="confirmModal" class="modal-overlay hidden">
      <div class="modal-content card">
        <div class="modal-header">
          <h3 class="text-lg font-semibold">확인</h3>
        </div>
        <div class="modal-body">
          <p id="confirmMessage" class="mb-6"></p>
          <div class="flex justify-end gap-4">
            <button
              type="button"
              id="confirmCancel"
              class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm interactive-button"
            >
              취소
            </button>
            <button
              type="button"
              id="confirmOk"
              class="px-4 py-2 border border-transparent rounded-lg shadow-sm text-white bg-red-600 hover:bg-red-700 interactive-button"
            >
              확인
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="authModal" class="modal-overlay">
      <div class="modal-content card max-w-md">
        <div class="text-center mb-8">
          <div class="relative inline-block mb-6">
            <img
              src="https://i.imgur.com/21d3e2k.png"
              alt="Logo"
              class="h-20 w-auto app-logo mx-auto drop-shadow-lg"
            />
            <div
              class="absolute -bottom-2 left-1/2 transform -translate-x-1/2 w-16 h-1 bg-gradient-to-r from-transparent via-luxury-gold-400 to-transparent rounded-full"
            ></div>
          </div>
          <h3
            class="text-2xl font-bold luxury-heading text-luxury-navy-900 dark:text-white mb-2"
            style="color: var(--luxury-navy-900)"
          >
            SI사업2팀
          </h3>
          <p
            class="text-sm text-luxury-navy-500 dark:text-luxury-navy-400"
            style="color: var(--luxury-navy-500)"
          >
            고객지원 시스템에 로그인하세요
          </p>
        </div>
        <div class="modal-body">
          <div class="space-y-5">
            <div class="relative">
              <label
                class="block text-xs font-semibold uppercase tracking-wider text-luxury-navy-600 mb-2"
                style="color: var(--luxury-navy-600)"
                >이메일</label
              >
              <div class="relative">
                <i
                  class="fas fa-envelope absolute left-4 top-1/2 transform -translate-y-1/2 text-luxury-navy-400"
                ></i>
                <input
                  type="email"
                  id="loginEmailInput"
                  name="email"
                  placeholder="name@company.com"
                  class="form-input block w-full pl-12 pr-4 py-3.5 bg-white/80 dark:bg-slate-800/80"
                  required
                  autocomplete="email"
                />
              </div>
            </div>
            <div class="relative">
              <label
                class="block text-xs font-semibold uppercase tracking-wider text-luxury-navy-600 mb-2"
                style="color: var(--luxury-navy-600)"
                >비밀번호</label
              >
              <div class="relative">
                <i
                  class="fas fa-lock absolute left-4 top-1/2 transform -translate-y-1/2 text-luxury-navy-400"
                ></i>
                <input
                  type="password"
                  id="loginPasswordInput"
                  name="password"
                  placeholder="••••••••"
                  class="form-input block w-full pl-12 pr-4 py-3.5 bg-white/80 dark:bg-slate-800/80"
                  required
                  autocomplete="current-password"
                />
              </div>
            </div>
          </div>

          <button
            type="button"
            id="loginButton"
            class="w-full flex justify-center items-center py-4 px-6 mt-8 rounded-xl text-base font-semibold text-white interactive-button relative overflow-hidden group"
            style="
              background: linear-gradient(135deg, var(--luxury-navy-800), var(--luxury-navy-900));
              border: 1px solid rgba(212, 175, 55, 0.3);
            "
          >
            <span class="relative z-10 flex items-center gap-2">
              <span>로그인</span>
              <i
                class="fas fa-arrow-right text-sm transition-transform group-hover:translate-x-1"
              ></i>
            </span>
          </button>

          <div class="mt-6 pt-6 border-t border-luxury-navy-100 dark:border-luxury-navy-800">
            <p class="text-center text-sm" style="color: var(--luxury-navy-500)">
              계정이 없으신가요?
              <button
                type="button"
                id="goToSignupButton"
                class="font-semibold ml-1 transition-colors hover:underline"
                style="color: var(--luxury-gold-600)"
              >
                회원가입
              </button>
            </p>
          </div>

          <div
            id="loginMessage"
            class="mt-4 p-4 rounded-xl text-sm hidden border"
            style="
              background: rgba(239, 68, 68, 0.1);
              border-color: rgba(239, 68, 68, 0.2);
              color: #dc2626;
            "
          ></div>
        </div>
      </div>
    </div>

    <div id="signupModal" class="modal-overlay hidden">
      <div class="modal-content card max-w-md">
        <div class="text-center mb-8">
          <div class="relative inline-block mb-6">
            <img
              src="https://i.imgur.com/21d3e2k.png"
              alt="Logo"
              class="h-20 w-auto app-logo mx-auto drop-shadow-lg"
            />
            <div
              class="absolute -bottom-2 left-1/2 transform -translate-x-1/2 w-16 h-1 bg-gradient-to-r from-transparent via-luxury-gold-400 to-transparent rounded-full"
            ></div>
          </div>
          <h3
            class="text-2xl font-bold luxury-heading text-luxury-navy-900 dark:text-white mb-2"
            style="color: var(--luxury-navy-900)"
          >
            Create Account
          </h3>
          <p
            class="text-sm text-luxury-navy-500 dark:text-luxury-navy-400"
            style="color: var(--luxury-navy-500)"
          >
            새 계정을 만들어주세요
          </p>
        </div>
        <div class="modal-body">
          <div class="space-y-5">
            <div class="relative">
              <label
                class="block text-xs font-semibold uppercase tracking-wider text-luxury-navy-600 mb-2"
                style="color: var(--luxury-navy-600)"
                >이름</label
              >
              <div class="relative">
                <i
                  class="fas fa-user absolute left-4 top-1/2 transform -translate-y-1/2 text-luxury-navy-400"
                ></i>
                <input
                  type="text"
                  id="signupNameInput"
                  name="name"
                  placeholder="홍길동"
                  class="form-input block w-full pl-12 pr-4 py-3.5 bg-white/80 dark:bg-slate-800/80"
                  required
                  autocomplete="name"
                />
              </div>
            </div>
            <div class="relative">
              <label
                class="block text-xs font-semibold uppercase tracking-wider text-luxury-navy-600 mb-2"
                style="color: var(--luxury-navy-600)"
                >이메일</label
              >
              <div class="relative">
                <i
                  class="fas fa-envelope absolute left-4 top-1/2 transform -translate-y-1/2 text-luxury-navy-400"
                ></i>
                <input
                  type="email"
                  id="signupEmailInput"
                  name="email"
                  placeholder="name@company.com"
                  class="form-input block w-full pl-12 pr-4 py-3.5 bg-white/80 dark:bg-slate-800/80"
                  required
                  autocomplete="email"
                />
              </div>
            </div>
            <div class="relative">
              <label
                class="block text-xs font-semibold uppercase tracking-wider text-luxury-navy-600 mb-2"
                style="color: var(--luxury-navy-600)"
                >비밀번호</label
              >
              <div class="relative">
                <i
                  class="fas fa-lock absolute left-4 top-1/2 transform -translate-y-1/2 text-luxury-navy-400"
                ></i>
                <input
                  type="password"
                  id="signupPasswordInput"
                  name="password"
                  placeholder="6자 이상 입력하세요"
                  class="form-input block w-full pl-12 pr-4 py-3.5 bg-white/80 dark:bg-slate-800/80"
                  required
                  autocomplete="new-password"
                />
              </div>
            </div>
          </div>

          <button
            type="button"
            id="signupButton"
            class="w-full flex justify-center items-center py-4 px-6 mt-8 rounded-xl text-base font-semibold text-white interactive-button relative overflow-hidden group"
            style="
              background: linear-gradient(135deg, var(--luxury-navy-800), var(--luxury-navy-900));
              border: 1px solid rgba(212, 175, 55, 0.3);
            "
          >
            <span class="relative z-10 flex items-center gap-2">
              <span>회원가입</span>
              <i class="fas fa-user-plus text-sm"></i>
            </span>
          </button>

          <div class="mt-6 pt-6 border-t border-luxury-navy-100 dark:border-luxury-navy-800">
            <p class="text-center text-sm" style="color: var(--luxury-navy-500)">
              이미 계정이 있으신가요?
              <button
                type="button"
                id="goToLoginButton"
                class="font-semibold ml-1 transition-colors hover:underline"
                style="color: var(--luxury-gold-600)"
              >
                로그인
              </button>
            </p>
          </div>

          <div
            id="signupMessage"
            class="mt-4 p-4 rounded-xl text-sm hidden border"
            style="
              background: rgba(239, 68, 68, 0.1);
              border-color: rgba(239, 68, 68, 0.2);
              color: #dc2626;
            "
          ></div>
        </div>
      </div>
    </div>

    <div id="appContainer" class="flex flex-col w-full h-screen bg-bg-color hidden">
      <header id="mainHeader" class="p-4 sm:p-5 flex-shrink-0">
        <nav class="flex items-center justify-between max-w-7xl mx-auto gap-3 sm:gap-4">
          <div class="flex items-center gap-4 flex-shrink-0 min-w-0">
            <div class="relative">
              <img
                src="/image/logo.jpg"
                alt="Logo"
                class="h-20 w-auto app-logo mx-auto drop-shadow-lg"
                onerror="this.src = 'https://i.imgur.com/21d3e2k.png'"
              />
              <div
                class="absolute -bottom-1 -right-1 w-3 h-3 bg-luxury-gold-400 rounded-full border-2 border-white dark:border-slate-800 shadow-sm"
                style="background: #d4af37"
              ></div>
            </div>
            <div class="min-w-0">
              <p class="header-meta">Business Support Desk</p>
              <h1
                class="text-base sm:text-xl font-bold text-white leading-tight truncate luxury-heading"
              >
                고객지원 현황
              </h1>
            </div>
          </div>

          <div class="header-search-wrap flex-grow relative min-w-[140px] max-w-2xl">
            <input
              type="text"
              id="unifiedSearchInput"
              class="form-input w-full pl-10 pr-4 py-2.5 text-sm sm:text-base"
              placeholder="통합 검색..."
              autocomplete="off"
            />
            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
          </div>

          <div class="flex items-center gap-2 sm:gap-4 flex-shrink-0">
            <button
              type="button"
              id="openWorkLogModalButton"
              class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg interactive-button"
            >
              <i class="fas fa-plus"></i>
              <span class="hidden sm:inline">등록</span>
            </button>
            <div id="userMenu" class="relative"></div>
          </div>
        </nav>
      </header>
      <main id="mainContent" class="flex-grow overflow-y-auto">
        <div class="max-w-7xl mx-auto w-full p-6 sm:p-8">
          <div
            id="announcement-banner"
            class="hidden mb-6 p-4 bg-yellow-100 dark:bg-yellow-900/30 border border-yellow-200 dark:border-yellow-800 rounded-lg text-sm text-yellow-800 dark:text-yellow-200 flex items-start gap-3"
          >
            <i class="fas fa-bullhorn mt-1"></i>
            <div id="announcement-content"></div>
          </div>

          <div>
            <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
              <h3
                class="text-xl font-semibold text-luxury-navy-900 dark:text-white luxury-heading tracking-tight"
                style="color: var(--luxury-navy-900)"
              >
                고객 지원 내역
              </h3>
              <div class="flex flex-wrap items-center gap-4">
                <div id="myRecordsFilterContainer" class="flex items-center">
                  <input
                    type="checkbox"
                    id="myRecordsFilter"
                    name="myRecordsFilter"
                    class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                  />
                  <label
                    for="myRecordsFilter"
                    class="ml-2 block text-sm text-gray-800 dark:text-white"
                    >내 기록</label
                  >
                </div>
                <div class="flex items-center gap-2">
                  <select id="exportMonthFilter" class="form-select text-sm py-1.5"></select>
                  <button
                    type="button"
                    id="exportCsvButton"
                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-1.5 px-3 rounded-lg interactive-button text-sm"
                  >
                    <i class="fas fa-file-csv mr-1"></i
                    ><span class="hidden sm:inline">내보내기</span>
                  </button>
                </div>
                <div
                  id="viewToggleContainer"
                  class="flex items-center bg-gray-200 dark:bg-gray-700 rounded-full p-1"
                >
                  <button
                    type="button"
                    id="listViewToggle"
                    class="px-3 py-1 text-sm rounded-full text-gray-600 dark:text-gray-300"
                  >
                    목록
                  </button>
                  <button
                    type="button"
                    id="calendarViewToggle"
                    class="px-3 py-1 text-sm rounded-full bg-white dark:bg-gray-500 shadow text-gray-800 dark:text-white"
                  >
                    캘린더
                  </button>
                </div>
              </div>
            </div>

            <div id="listViewContainer" class="card p-6 hidden">
              <div class="flex justify-end items-center mb-4">
                <button
                  type="button"
                  id="deleteSelectedButton"
                  class="hidden bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg interactive-button"
                >
                  <i class="fas fa-trash-alt mr-2"></i>선택 항목 삭제
                </button>
              </div>
              <div class="overflow-x-auto">
                <table
                  class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 responsive-table"
                >
                  <thead class="bg-gray-100 dark:bg-gray-700">
                    <tr>
                      <th id="selectAllHeader" class="px-4 py-3 text-left" style="display: none">
                        <input type="checkbox" id="selectAllCheckbox" />
                      </th>
                      <th
                        class="px-4 py-3 text-left text-sm font-bold text-gray-800 dark:text-white uppercase tracking-wider"
                      >
                        일자
                      </th>
                      <th
                        class="px-4 py-3 text-left text-sm font-bold text-gray-800 dark:text-white uppercase tracking-wider"
                      >
                        이름
                      </th>
                      <th
                        class="px-4 py-3 text-left text-sm font-bold text-gray-800 dark:text-white uppercase tracking-wider"
                      >
                        고객사명
                      </th>
                      <th
                        class="px-4 py-3 text-left text-sm font-bold text-gray-800 dark:text-white uppercase tracking-wider"
                      >
                        지원내용
                      </th>
                      <th
                        class="px-4 py-3 text-left text-sm font-bold text-gray-800 dark:text-white uppercase tracking-wider"
                      >
                        지원시간
                      </th>
                      <th
                        class="px-4 py-3 text-left text-sm font-bold text-gray-800 dark:text-white uppercase tracking-wider"
                      >
                        총 시간(H)
                      </th>
                      <th
                        class="px-4 py-3 text-right text-sm font-bold text-gray-800 dark:text-white uppercase tracking-wider"
                      >
                        액션
                      </th>
                    </tr>
                  </thead>
                  <tbody
                    id="recordsTableBody"
                    class="divide-y divide-gray-200 dark:divide-gray-700"
                  ></tbody>
                </table>
              </div>
              <div id="paginationControls" class="mt-4 flex justify-center items-sm gap-2"></div>
            </div>
            <div id="calendarViewContainer" class="mt-4 card p-6">
              <div id="calendar"></div>
            </div>
          </div>

          <div id="dashboardContainer" class="mt-12 p-8 rounded-3xl card">
            <div class="flex flex-wrap justify-between items-center mb-6 gap-2">
              <h3
                class="text-2xl font-bold text-luxury-navy-900 dark:text-white luxury-heading"
                style="color: var(--luxury-navy-900)"
              >
                업무 현황 대시보드
              </h3>
              <div
                id="dashboardToggleContainer"
                class="flex items-center bg-gray-200 dark:bg-gray-700 rounded-full p-1"
              >
                <button
                  type="button"
                  id="teamDashboardToggle"
                  class="px-3 py-1 text-sm rounded-full text-gray-800 dark:text-gray-300"
                >
                  팀
                </button>
                <button
                  type="button"
                  id="personalDashboardToggle"
                  class="px-3 py-1 text-sm rounded-full bg-white dark:bg-gray-500 shadow text-gray-800 dark:text-white"
                >
                  개인
                </button>
              </div>
            </div>
            <div class="mb-6">
              <div class="flex items-center gap-2 mb-3">
                <i class="fas fa-calendar-alt text-luxury-navy-400 text-sm"></i>
                <label
                  for="dashboardMonthFilter"
                  class="text-xs font-semibold uppercase tracking-wider"
                  style="color: var(--luxury-navy-500)"
                  >조회 기간</label
                >
              </div>
              <input
                type="month"
                id="dashboardMonthFilter"
                name="dashboardMonthFilter"
                class="w-full md:w-48"
                autocomplete="off"
              />
            </div>
            <div id="teamDashboard" class="grid grid-cols-2 lg:grid-cols-4 gap-4 hidden"></div>
            <div id="personalDashboard" class="grid grid-cols-2 lg:grid-cols-4 gap-4"></div>
          </div>
        </div>
      </main>
    </div>

    <div id="profileModal" class="modal-overlay hidden"></div>
    <div id="userManagementModal" class="modal-overlay hidden"></div>
    <div id="templateModal" class="modal-overlay hidden"></div>
    <div id="editUserModal" class="modal-overlay hidden"></div>
    <div id="eventDetailModal" class="modal-overlay hidden"></div>

    <div id="workLogModal" class="modal-overlay hidden">
      <div class="modal-content card !max-w-6xl">
        <div class="modal-header">
          <h3 class="luxury-heading text-2xl font-semibold text-luxury-navy-900 dark:text-white">
            고객 지원 업무 등록
          </h3>
          <button type="button" id="closeWorkLogModal" class="text-2xl hover:text-red-500">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <form id="workLogForm">
            <datalist id="client-list"></datalist>
            <fieldset id="formFieldset" class="space-y-6">
              <!-- Section 1: 기본 정보 -->
              <div
                class="bg-gray-50 dark:bg-gray-800/50 p-5 rounded-xl border border-gray-100 dark:border-gray-700"
              >
                <h4
                  class="text-xs font-bold uppercase tracking-[0.2em] mb-4 border-b border-luxury-gold-200 dark:border-luxury-gold-700/50 pb-3 flex items-center gap-2 text-luxury-navy-700 dark:text-luxury-gold-300"
                  style="color: var(--luxury-navy-700)"
                >
                  <i class="fas fa-info-circle text-luxury-gold-500" style="color: #d4af37"></i>기본
                  정보
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                  <div>
                    <label
                      for="date"
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                      >일자</label
                    >
                    <div class="relative">
                      <input
                        type="text"
                        id="date"
                        name="date"
                        class="form-input mt-1 block w-full pl-10 pr-4 py-2.5"
                        placeholder="날짜 선택"
                        required
                        autocomplete="off"
                      />
                      <i
                        class="fas fa-calendar absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"
                      ></i>
                    </div>
                    <p class="form-error-message hidden"></p>
                  </div>
                  <div>
                    <label
                      for="name"
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                      >이름</label
                    >
                    <input
                      type="text"
                      id="name"
                      name="name"
                      class="form-input mt-1 block w-full px-4 py-2.5 bg-gray-100 dark:bg-gray-700 text-gray-500 cursor-not-allowed"
                      readonly
                      autocomplete="off"
                    />
                  </div>
                  <div>
                    <label
                      for="client"
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                      >고객사명</label
                    >
                    <input
                      type="text"
                      id="client"
                      name="client"
                      list="client-list"
                      placeholder="고객사명 입력"
                      class="form-input mt-1 block w-full px-4 py-2.5"
                      required
                      autocomplete="organization"
                    />
                    <p class="form-error-message hidden"></p>
                  </div>
                  <div>
                    <label
                      for="place"
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                      >장소</label
                    >
                    <input
                      type="text"
                      id="place"
                      name="place"
                      class="form-input mt-1 block w-full px-4 py-2.5"
                      required
                      autocomplete="off"
                      placeholder="방문 장소"
                    />
                    <p class="form-error-message hidden"></p>
                  </div>
                  <div class="md:col-span-2">
                    <label
                      for="supportType"
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                      >지원유형</label
                    >
                    <select
                      id="supportType"
                      name="supportType"
                      class="form-select mt-1 block w-full px-4 py-2.5"
                      required
                      autocomplete="off"
                    >
                      <option value="">선택하세요</option>
                    </select>
                    <p class="form-error-message hidden"></p>
                  </div>
                </div>
              </div>

              <!-- Section 2: 시간 정보 -->
              <div
                class="bg-gray-50 dark:bg-gray-800/50 p-5 rounded-xl border border-gray-100 dark:border-gray-700"
              >
                <div
                  class="flex justify-between items-center mb-4 border-b border-luxury-gold-200 dark:border-luxury-gold-700/50 pb-3"
                >
                  <h4
                    class="text-xs font-bold uppercase tracking-[0.2em] flex items-center gap-2 text-luxury-navy-700 dark:text-luxury-gold-300"
                    style="color: var(--luxury-navy-700)"
                  >
                    <i class="fas fa-clock text-luxury-gold-500" style="color: #d4af37"></i>시간
                    정보
                  </h4>
                  <button
                    type="button"
                    id="clearTimesButton"
                    class="text-xs text-luxury-navy-500 hover:text-luxury-gold-600 dark:text-luxury-navy-400 dark:hover:text-luxury-gold-400 transition-colors font-medium"
                    style="color: var(--luxury-navy-500)"
                  >
                    <i class="fas fa-sync-alt mr-1"></i>초기화
                  </button>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div>
                    <label
                      for="departureTime"
                      class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1"
                      >출발</label
                    >
                    <input
                      type="text"
                      id="departureTime"
                      name="departureTime"
                      class="form-input block w-full px-3 py-2 text-sm"
                      placeholder="00:00"
                      autocomplete="off"
                    />
                  </div>
                  <div>
                    <label
                      for="arrivalTime"
                      class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1"
                      >도착</label
                    >
                    <input
                      type="text"
                      id="arrivalTime"
                      name="arrivalTime"
                      class="form-input block w-full px-3 py-2 text-sm"
                      placeholder="00:00"
                      autocomplete="off"
                    />
                  </div>
                  <div>
                    <label
                      for="startTime"
                      class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1"
                      >시작</label
                    >
                    <input
                      type="text"
                      id="startTime"
                      name="startTime"
                      class="form-input block w-full px-3 py-2 text-sm"
                      placeholder="00:00"
                      autocomplete="off"
                    />
                  </div>
                  <div>
                    <label
                      for="endTime"
                      class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1"
                      >종료</label
                    >
                    <input
                      type="text"
                      id="endTime"
                      name="endTime"
                      class="form-input block w-full px-3 py-2 text-sm"
                      placeholder="00:00"
                      autocomplete="off"
                    />
                  </div>
                  <div class="col-span-2 md:col-span-4 mt-2">
                    <label
                      for="supportHours"
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                      >총 지원 시간 (이동 포함)</label
                    >
                    <div class="relative">
                      <input
                        type="number"
                        id="supportHours"
                        name="supportHours"
                        class="form-input block w-full pl-4 pr-12 py-2.5 bg-indigo-50 dark:bg-indigo-900/20 border-indigo-200 dark:border-indigo-800 text-indigo-700 dark:text-indigo-300 font-bold"
                        readonly
                        required
                        placeholder="0"
                        autocomplete="off"
                      />
                      <span
                        class="absolute right-4 top-1/2 -translate-y-1/2 text-sm text-indigo-500 font-medium"
                        >시간</span
                      >
                    </div>
                  </div>
                </div>
              </div>

              <!-- Section 3: 상세 내용 -->
              <div
                class="bg-gray-50 dark:bg-gray-800/50 p-5 rounded-xl border border-gray-100 dark:border-gray-700"
              >
                <h4
                  class="text-xs font-bold uppercase tracking-[0.2em] mb-4 border-b border-luxury-gold-200 dark:border-luxury-gold-700/50 pb-3 flex items-center gap-2 text-luxury-navy-700 dark:text-luxury-gold-300"
                  style="color: var(--luxury-navy-700)"
                >
                  <i class="fas fa-align-left text-luxury-gold-500" style="color: #d4af37"></i>상세
                  내용
                </h4>
                <div>
                  <textarea
                    id="details"
                    name="details"
                    rows="4"
                    placeholder="상세 지원 내용을 입력하세요 (최소 10자)"
                    minlength="10"
                    class="form-textarea mt-1 block w-full px-4 py-3"
                    required
                    autocomplete="off"
                  ></textarea>
                  <p class="form-error-message hidden"></p>
                  <p class="text-xs text-gray-400 mt-1 text-right">
                    * 최소 10자 이상 입력해주세요.
                  </p>
                </div>
              </div>

              <div
                id="formActions"
                class="mt-8 flex gap-3 pt-4 border-t border-gray-200 dark:border-gray-700"
              >
                <button
                  type="button"
                  id="templateButton"
                  class="py-3 px-5 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-bold rounded-xl interactive-button transition-colors"
                >
                  <i class="fas fa-paste mr-2"></i>템플릿
                </button>
                <div class="flex-grow"></div>
                <button
                  type="button"
                  id="cancelEditButton"
                  class="hidden py-3 px-6 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-bold rounded-xl interactive-button shadow-sm"
                >
                  취소
                </button>
                <button
                  type="submit"
                  id="submitButton"
                  class="flex-grow md:flex-grow-0 py-3 px-8 border border-transparent rounded-xl shadow-md text-base font-bold text-white bg-indigo-600 hover:bg-indigo-700 interactive-button transition-all hover:shadow-lg hover:-translate-y-0.5"
                >
                  <i class="fas fa-paper-plane mr-2"></i>기록 제출
                </button>
              </div>
            </fieldset>
          </form>
        </div>
      </div>
    </div>
    <script src="holidays.js"></script>
    <script src="admin-holidays.js"></script>
    <script type="module">
      // Firebase SDKs
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js';
      import {
        getAuth,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        onAuthStateChanged,
        signOut,
        updateProfile,
        EmailAuthProvider,
        reauthenticateWithCredential,
        updatePassword,
      } from 'https://www.gstatic.com/firebasejs/10.10.0/firebase-auth.js';
      import {
        getFirestore,
        collection,
        addDoc,
        query,
        onSnapshot,
        orderBy,
        where,
        doc,
        deleteDoc,
        setDoc,
        getDoc,
        limit,
        startAfter,
        getDocs,
        runTransaction,
        serverTimestamp,
        endBefore,
        limitToLast,
        writeBatch,
        updateDoc,
      } from 'https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js';

      // --- Refactored App Architecture ---
      // 1) CONFIG
      const CONFIG = {
        RECORDS_PER_PAGE: 10,
        DEFAULT_THEME: 'light',
        LUNCH_START: '12:00:00',
        LUNCH_END: '13:00:00',
        CSV_BOM: '\uFEFF',
      };

      // 2) Data Models
      class UserModel {
        constructor({
          uid,
          email,
          displayName,
          role = 'user',
          status = 'active',
          createdAt = null,
          lastLogin = null,
        }) {
          this.uid = uid;
          this.email = email;
          this.displayName = displayName;
          this.role = role;
          this.status = status;
          this.createdAt = createdAt;
          this.lastLogin = lastLogin;
        }

        toFirestore() {
          return {
            displayName: this.displayName,
            email: this.email,
            role: this.role,
            status: this.status,
            createdAt: this.createdAt,
            lastLogin: this.lastLogin,
          };
        }
      }

      class WorkLogModel {
        constructor(payload = {}) {
          Object.assign(this, payload);
        }

        toFirestore() {
          return {
            date: this.date,
            name: this.name,
            client: this.client,
            place: this.place,
            supportType: this.supportType,
            departureTime: this.departureTime,
            arrivalTime: this.arrivalTime,
            startTime: this.startTime,
            endTime: this.endTime,
            supportHours: this.supportHours,
            details: this.details,
            submittedBy: this.submittedBy,
            timestamp: this.timestamp,
          };
        }

        static fromForm(form, userUid) {
          return new WorkLogModel({
            date: form.date.value,
            name: form.name.value,
            client: form.client.value,
            place: form.place.value,
            supportType: form.supportType.value,
            departureTime: form.departureTime.value,
            arrivalTime: form.arrivalTime.value,
            startTime: form.startTime.value,
            endTime: form.endTime.value,
            supportHours: parseFloat(form.supportHours.value) || 0,
            details: form.details.value,
            submittedBy: userUid,
            timestamp: serverTimestamp(),
          });
        }
      }

      class TemplateModel {
        constructor({ name, client, place, supportType, details }) {
          this.name = name;
          this.client = client;
          this.place = place;
          this.supportType = supportType;
          this.details = details;
        }

        toFirestore() {
          return {
            name: this.name,
            client: this.client,
            place: this.place,
            supportType: this.supportType,
            details: this.details,
          };
        }

        static fromForm(form, fallbackName = '') {
          return new TemplateModel({
            name: fallbackName || form.dataset.templateName || '',
            client: form.client.value,
            place: form.place.value,
            supportType: form.supportType.value,
            details: form.details.value,
          });
        }
      }

      // App state container (legacy globals are kept for backward compatibility)
      let db, auth;
      let currentUser = null;
      let currentPage = 1;
      let userListenerUnsubscribe = null;
      let editingRecordId = null;
      let allRecords = [];
      let chartInstances = {};
      let appEventListenersAttached = false;
      let setupUiListenerController = null;
      let selectAllListenerAttached = false;
      let calendar;
      let datePicker;
      let appConfigListenerUnsubscribe = null;
      let announcementListenerUnsubscribe = null;
      let supportTypesListenerUnsubscribe = null;
      let recordsListenerUnsubscribe = null;

      const AppState = {
        get db() {
          return db;
        },
        set db(value) {
          db = value;
        },
        get auth() {
          return auth;
        },
        set auth(value) {
          auth = value;
        },
        get currentUser() {
          return currentUser;
        },
        set currentUser(value) {
          currentUser = value;
        },
        get currentPage() {
          return currentPage;
        },
        set currentPage(value) {
          currentPage = value;
        },
        get userListenerUnsubscribe() {
          return userListenerUnsubscribe;
        },
        set userListenerUnsubscribe(value) {
          userListenerUnsubscribe = value;
        },
        get editingRecordId() {
          return editingRecordId;
        },
        set editingRecordId(value) {
          editingRecordId = value;
        },
        get allRecords() {
          return allRecords;
        },
        set allRecords(value) {
          allRecords = value;
        },
        get chartInstances() {
          return chartInstances;
        },
        set chartInstances(value) {
          chartInstances = value;
        },
        get appEventListenersAttached() {
          return appEventListenersAttached;
        },
        set appEventListenersAttached(value) {
          appEventListenersAttached = value;
        },
        get calendar() {
          return calendar;
        },
        set calendar(value) {
          calendar = value;
        },
        get datePicker() {
          return datePicker;
        },
        set datePicker(value) {
          datePicker = value;
        },
        get appConfigListenerUnsubscribe() {
          return appConfigListenerUnsubscribe;
        },
        set appConfigListenerUnsubscribe(value) {
          appConfigListenerUnsubscribe = value;
        },
        get announcementListenerUnsubscribe() {
          return announcementListenerUnsubscribe;
        },
        set announcementListenerUnsubscribe(value) {
          announcementListenerUnsubscribe = value;
        },
        get supportTypesListenerUnsubscribe() {
          return supportTypesListenerUnsubscribe;
        },
        set supportTypesListenerUnsubscribe(value) {
          supportTypesListenerUnsubscribe = value;
        },
        get recordsListenerUnsubscribe() {
          return recordsListenerUnsubscribe;
        },
        set recordsListenerUnsubscribe(value) {
          recordsListenerUnsubscribe = value;
        },
        resetPagination() {
          this.currentPage = 1;
        },
      };

      // 3) Service Layer (Firebase access)
      const AuthService = {
        login(email, password) {
          return signInWithEmailAndPassword(AppState.auth, email, password);
        },
        signup(email, password) {
          return createUserWithEmailAndPassword(AppState.auth, email, password);
        },
        signOut() {
          return signOut(AppState.auth);
        },
        watchAuthState(callback) {
          return onAuthStateChanged(AppState.auth, callback);
        },
      };

      const UserService = {
        getUserDocRef(uid) {
          return doc(AppState.db, 'users', uid);
        },
        upsertUser(uid, userData, options = { merge: true }) {
          return setDoc(this.getUserDocRef(uid), userData, options);
        },
        watchUser(uid, onNext, onError) {
          return onSnapshot(this.getUserDocRef(uid), onNext, onError);
        },
        fetchAll() {
          return getDocs(collection(AppState.db, 'users'));
        },
        updateUser(userId, updateData) {
          return updateDoc(doc(AppState.db, 'users', userId), updateData);
        },
      };

      const WorkLogService = {
        getCollection() {
          return collection(AppState.db, 'work_logs');
        },
        watchAll(onNext, onError) {
          return onSnapshot(
            query(this.getCollection(), orderBy('timestamp', 'desc'), limit(100)),
            onNext,
            onError,
          );
        },
        watchRecent(onNext, onError) {
          return onSnapshot(
            query(this.getCollection(), orderBy('timestamp', 'desc'), limit(50)),
            onNext,
            onError,
          );
        },
        create(recordData) {
          return addDoc(this.getCollection(), recordData);
        },
        update(recordId, recordData, options = { merge: true }) {
          return setDoc(doc(AppState.db, 'work_logs', recordId), recordData, options);
        },
        delete(recordId) {
          return deleteDoc(doc(AppState.db, 'work_logs', recordId));
        },
      };

      const TemplateService = {
        getCollection(uid) {
          return collection(AppState.db, 'users', uid, 'templates');
        },
        fetchAll(uid) {
          return getDocs(query(this.getCollection(uid), orderBy('name')));
        },
        save(uid, templateId, templateData) {
          if (templateId) {
            return setDoc(doc(AppState.db, 'users', uid, 'templates', templateId), templateData, {
              merge: true,
            });
          }
          return addDoc(this.getCollection(uid), templateData);
        },
        delete(uid, templateId) {
          return deleteDoc(doc(AppState.db, 'users', uid, 'templates', templateId));
        },
      };

      const SettingsService = {
        watchSupportTypes(onNext) {
          return onSnapshot(
            collection(AppState.db, 'settings', 'appConfig', 'supportTypes'),
            onNext,
          );
        },
        watchAppConfig(onNext) {
          return onSnapshot(doc(AppState.db, 'settings', 'appConfig'), onNext);
        },
        watchAnnouncement(onNext) {
          return onSnapshot(doc(AppState.db, 'settings', 'announcement'), onNext);
        },
      };

      // 4) UI Managers and 5) Utilities
      const Utils = {
        parseTimeToDate(time) {
          return new Date(`1970-01-01T${time}:00`);
        },
        escapeCsv(data) {
          return `"${(data || '').toString().replace(/"/g, '""')}"`;
        },
        getEventInitial(name) {
          if (!name) return '?';
          const cleanName = name.trim();
          return cleanName.length >= 2 ? cleanName.substring(0, 2) : cleanName.charAt(0);
        },
      };

      function sanitizeCsvValue(value) {
        const stringValue = (value ?? '').toString();
        return /^[=+\-@]/.test(stringValue) ? `'${stringValue}` : stringValue;
      }

      function isAdminUser() {
        return Boolean(currentUser && currentUser.role === 'admin');
      }

      function ensureAdminAccess() {
        if (!isAdminUser()) {
          showToast('error', '관리자 권한이 필요합니다.');
          return false;
        }
        return true;
      }

      // --- Functions Declaration (Moved to the top for stability) ---

      function validateForm() {
        const form = document.getElementById('workLogForm');
        let isValid = true;
        const isTemplateEdit = form.hasAttribute('data-template-id');
        form.querySelectorAll('[required]').forEach((input) => {
          const parent = input.closest('div');
          const errorMsg = parent.querySelector('.form-error-message');
          if (isTemplateEdit && (input.id === 'date' || input.id === 'supportHours')) {
            input.classList.remove('is-invalid');
            if (errorMsg) errorMsg.classList.add('hidden');
            return;
          }
          if (!input.value.trim()) {
            isValid = false;
            input.classList.add('is-invalid');
            if (errorMsg) {
              errorMsg.textContent = '필수 입력 항목입니다.';
              errorMsg.classList.remove('hidden');
            }
          } else {
            input.classList.remove('is-invalid');
            if (errorMsg) {
              errorMsg.classList.add('hidden');
            }
          }
        });
        return isValid;
      }

      // --- UI & Event Handlers ---
      function handleSelectAllCheckboxChange(e) {
        document.querySelectorAll('#recordsTableBody .record-checkbox').forEach((checkbox) => {
          checkbox.checked = e.target.checked;
        });
      }

      function createRipple(event) {
        const button = event.currentTarget;
        const circle = document.createElement('span');
        const diameter = Math.max(button.clientWidth, button.clientHeight);
        const radius = diameter / 2;

        circle.style.width = circle.style.height = `${diameter}px`;
        circle.style.left = `${event.clientX - button.getBoundingClientRect().left - radius}px`;
        circle.style.top = `${event.clientY - button.getBoundingClientRect().top - radius}px`;
        circle.classList.add('ripple');

        const ripple = button.getElementsByClassName('ripple')[0];

        if (ripple) {
          ripple.remove();
        }

        button.appendChild(circle);
      }

      let globalListenersAttached = false;
      function setupGlobalEventListeners() {
        if (globalListenersAttached) {
          console.log('[setupGlobalEventListeners] Already attached, skipping');
          return;
        }
        globalListenersAttached = true;

        // Use event delegation for ripple effect (more efficient and handles dynamic buttons)
        document.body.addEventListener('click', function (e) {
          const button = e.target.closest('.interactive-button');
          if (button) {
            createRipple({
              currentTarget: button,
              clientX: e.clientX,
              clientY: e.clientY,
            });
          }
        });

        document.getElementById('darkModeToggle').addEventListener('click', () => {
          const isDark = document.documentElement.classList.toggle('dark');
          localStorage.setItem('theme', isDark ? 'dark' : 'light');
          document.getElementById('darkModeToggle').innerHTML = isDark
            ? '<i class="fas fa-sun"></i>'
            : '<i class="fas fa-moon"></i>';
          applyAllFilters();
        });

        document.getElementById('loginButton').addEventListener('click', handleLogin);
        document.getElementById('signupButton').addEventListener('click', handleSignup);

        document.getElementById('goToSignupButton').addEventListener('click', () => {
          document.getElementById('authModal').classList.add('hidden');
          document.getElementById('signupModal').classList.remove('hidden');

          const signupModalContent = document.querySelector('#signupModal .modal-content');
          if (signupModalContent) {
            setTimeout(() => resetModalPosition(signupModalContent), 0);
          }
        });

        document.getElementById('goToLoginButton').addEventListener('click', () => {
          document.getElementById('signupModal').classList.add('hidden');
          document.getElementById('authModal').classList.remove('hidden');

          const authModalContent = document.querySelector('#authModal .modal-content');
          if (authModalContent) {
            setTimeout(() => resetModalPosition(authModalContent), 0);
          }
        });

        document.getElementById('loginPasswordInput').addEventListener('keydown', (event) => {
          if (event.key === 'Enter') {
            event.preventDefault();
            document.getElementById('loginButton').click();
          }
        });

        document.addEventListener('keydown', handleGlobalEscapeKey);
      }

      function setupAppEventListeners() {
        if (appEventListenersAttached) return;

        document.getElementById('openWorkLogModalButton').addEventListener('click', () => {
          closeFullCalendarPopovers();
          cancelEdit();
          document.getElementById('workLogModal').classList.remove('hidden');
          const modalContent = document.querySelector('#workLogModal .modal-content');
          if (modalContent) {
            resetModalPosition(modalContent);
          }
        });
        document.getElementById('closeWorkLogModal').addEventListener('click', () => {
          cancelEdit();
        });

        document.getElementById('workLogForm').addEventListener('submit', handleFormSubmit);
        document.getElementById('cancelEditButton').addEventListener('click', cancelEdit);
        document.getElementById('clearTimesButton').addEventListener('click', clearTimes);
        document.getElementById('templateButton').addEventListener('click', openTemplateModal);

        document
          .getElementById('unifiedSearchInput')
          .addEventListener('input', () => applyAllFilters());
        document
          .getElementById('myRecordsFilter')
          .addEventListener('change', () => applyAllFilters());

        document.getElementById('exportCsvButton').addEventListener('click', exportToCsv);

        document.getElementById('dashboardMonthFilter').addEventListener('change', updateDashboard);

        document
          .getElementById('teamDashboardToggle')
          .addEventListener('click', () => switchDashboard('team'));
        document
          .getElementById('personalDashboardToggle')
          .addEventListener('click', () => switchDashboard('personal'));

        document
          .getElementById('listViewToggle')
          .addEventListener('click', () => toggleView('list'));
        document
          .getElementById('calendarViewToggle')
          .addEventListener('click', () => toggleView('calendar'));

        document.getElementById('recordsTableBody').addEventListener('click', handleTableActions);

        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        if (selectAllCheckbox && !selectAllListenerAttached) {
          selectAllCheckbox.addEventListener('change', handleSelectAllCheckboxChange);
          selectAllListenerAttached = true;
        }

        if (currentUser && currentUser.role === 'admin') {
          const deleteSelectedButton = document.getElementById('deleteSelectedButton');
          if (deleteSelectedButton) {
            deleteSelectedButton.addEventListener('click', handleDeleteSelected);
          }
        }

        appEventListenersAttached = true;
      }

      function setupUI() {
        const userMenu = document.getElementById('userMenu');
        if (!userMenu) {
          console.error('[setupUI] userMenu element not found');
          return;
        }

        if (setupUiListenerController) {
          setupUiListenerController.abort();
        }
        setupUiListenerController = new AbortController();
        const setupUiSignal = setupUiListenerController.signal;

        if (
          localStorage.getItem('theme') === 'dark' ||
          (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)
        ) {
          document.documentElement.classList.add('dark');
          document.getElementById('darkModeToggle').innerHTML = '<i class="fas fa-sun"></i>';
        } else {
          document.documentElement.classList.remove('dark');
          document.getElementById('darkModeToggle').innerHTML = '<i class="fas fa-moon"></i>';
        }

        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth();
        const fiscalYearStartYear = currentMonth < 3 ? currentYear - 1 : currentYear;
        const minDate = `${fiscalYearStartYear}-04-01`;
        // maxDate 로직 수정: 현재 날짜의 1년 후까지만 선택 가능하도록 설정
        const maxDate = new Date(now.getFullYear() + 1, now.getMonth(), now.getDate());

        if (!datePicker) {
          datePicker = flatpickr('#workLogModal #date', {
            dateFormat: 'Y-m-d',
            locale: 'ko',
            defaultDate: 'today',
            minDate: minDate,
            maxDate: maxDate,
          });
        }

        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        document.getElementById('dashboardMonthFilter').value = `${year}-${month}`;

        flatpickr(
          '#workLogModal #startTime, #workLogModal #endTime, #workLogModal #departureTime, #workLogModal #arrivalTime',
          {
            enableTime: true,
            noCalendar: true,
            dateFormat: 'H:i',
            time_24hr: true,
            minuteIncrement: 15,
            onChange: function (selectedDates, dateStr, instance) {
              calculateSupportHours();
            },
          },
        );

        updateFiscalYearFilter();

        if (currentUser) {
          const adminMenuItem =
            currentUser.role === 'admin'
              ? `<a href="#" id="openUserManagementButton" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600" role="menuitem" tabindex="-1">관리자 설정</a>`
              : '';

          userMenu.innerHTML = `
                    <div>
                        <button type="button" id="userMenuButton" class="flex items-center gap-2 max-w-xs rounded-full bg-gray-200 dark:bg-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 dark:focus:ring-offset-gray-900 focus:ring-indigo-500">
                            <span class="sr-only">Open user menu</span>
                            <span id="userMenuButtonName" class="px-3 py-1.5 font-semibold text-gray-800 dark:text-gray-100"></span>
                            <i class="fas fa-chevron-down pr-3 text-gray-600 dark:text-gray-300"></i>
                        </button>
                    </div>
                    <div id="userMenuItems" class="origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg py-1 bg-white dark:bg-gray-800 ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-10" role="menu" aria-orientation="vertical" aria-labelledby="user-menu-button" tabindex="-1">
                        <div class="px-4 py-3 border-b border-border-color">
                            <p id="userMenuDisplayName" class="text-sm font-semibold truncate text-gray-900 dark:text-white"></p>
                            <p id="userMenuEmail" class="text-xs text-gray-500 dark:text-gray-400 truncate"></p>
                        </div>
                        <div class="py-1">
                            <a href="#" id="openProfileButton" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600" role="menuitem" tabindex="-1">내 정보</a>
                            <a href="#" id="openTemplateManagementButton" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600" role="menuitem" tabindex="-1">템플릿 관리</a>
                            ${adminMenuItem}
                        </div>
                        <div class="py-1 border-t border-border-color">
                            <a href="#" id="logoutButton" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600" role="menuitem" tabindex="-1">로그아웃</a>
                        </div>
                    </div>
                `;

          const menuDisplayName = currentUser.displayName || '';
          const menuEmail = currentUser.email || '';
          const userMenuButtonName = document.getElementById('userMenuButtonName');
          const userMenuDisplayName = document.getElementById('userMenuDisplayName');
          const userMenuEmail = document.getElementById('userMenuEmail');
          if (userMenuButtonName) userMenuButtonName.textContent = menuDisplayName;
          if (userMenuDisplayName) userMenuDisplayName.textContent = menuDisplayName;
          if (userMenuEmail) userMenuEmail.textContent = menuEmail;

          const userMenuButton = document.getElementById('userMenuButton');
          const userMenuItems = document.getElementById('userMenuItems');

          // 수정: 터치 디바이스를 위해 touchstart 이벤트 추가
          userMenuButton.addEventListener(
            'click',
            (event) => {
              event.stopPropagation();
              userMenuItems.classList.toggle('hidden');
            },
            { signal: setupUiSignal },
          );
          userMenuButton.addEventListener(
            'touchstart',
            (event) => {
              event.stopPropagation();
              userMenuItems.classList.toggle('hidden');
            },
            { signal: setupUiSignal },
          );

          document.addEventListener(
            'click',
            (event) => {
              if (!userMenu.contains(event.target)) {
                userMenuItems.classList.add('hidden');
              }
            },
            { signal: setupUiSignal },
          );
          // 수정: 터치 디바이스를 위해 touchstart 이벤트 추가
          document.addEventListener(
            'touchstart',
            (event) => {
              if (!userMenu.contains(event.target)) {
                userMenuItems.classList.add('hidden');
              }
            },
            { signal: setupUiSignal },
          );

          document.getElementById('openProfileButton').addEventListener(
            'click',
            (e) => {
              e.preventDefault();
              const profileModalContent = document.querySelector('#profileModal .modal-content');
              if (profileModalContent) resetModalPosition(profileModalContent);
              openProfileModal();
              userMenuItems.classList.add('hidden');
            },
            { signal: setupUiSignal },
          );
          document.getElementById('logoutButton').addEventListener(
            'click',
            (e) => {
              e.preventDefault();
              handleLogout();
            },
            { signal: setupUiSignal },
          );
          if (currentUser.role === 'admin') {
            document.getElementById('openUserManagementButton').addEventListener(
              'click',
              (e) => {
                e.preventDefault();
                const userManagementModalContent = document.querySelector(
                  '#userManagementModal .modal-content',
                );
                if (userManagementModalContent) resetModalPosition(userManagementModalContent);
                openUserManagementModal();
                userMenuItems.classList.add('hidden');
              },
              { signal: setupUiSignal },
            );
          }
          document.getElementById('openTemplateManagementButton').addEventListener(
            'click',
            (e) => {
              e.preventDefault();
              const templateModalContent = document.querySelector('#templateModal .modal-content');
              if (templateModalContent) resetModalPosition(templateModalContent);
              openTemplateModal();
              userMenuItems.classList.add('hidden');
            },
            { signal: setupUiSignal },
          );

          document.querySelector('#workLogModal #name').value = currentUser.displayName;
          document.querySelector('#workLogModal #formFieldset').disabled = false;

          const myRecordsContainer = document.getElementById('myRecordsFilterContainer');
          const workLogButton = document.getElementById('openWorkLogModalButton');
          if (currentUser.role === 'admin') {
            myRecordsContainer.classList.add('hidden');
            workLogButton.classList.add('hidden');
          } else {
            myRecordsContainer.classList.remove('hidden');
            workLogButton.classList.remove('hidden');
          }
        }

        toggleView('calendar');
        initializeCalendar();
        renderSkeleton(CONFIG.RECORDS_PER_PAGE);
      }

      // --- Firebase Listeners ---
      function setupFirestoreListeners() {
        if (!currentUser) return;

        // 로딩 상태 표시
        const isFirstLoad = allRecords.length === 0;
        if (isFirstLoad) {
          showToast('info', '데이터를 불러오는 중...', 2000);
        }

        if (supportTypesListenerUnsubscribe) supportTypesListenerUnsubscribe();
        supportTypesListenerUnsubscribe = SettingsService.watchSupportTypes((snapshot) => {
          const supportTypes = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
          populateSupportTypeDropdown(supportTypes);
        });

        if (recordsListenerUnsubscribe) recordsListenerUnsubscribe();
        recordsListenerUnsubscribe = WorkLogService.watchAll(
          (snapshot) => {
            allRecords = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
            updateClientDatalist(allRecords);
            applyAllFilters(true);
          },
          (error) => {
            console.error('Error listening to records:', error);
            showToast('error', '기록을 실시간으로 불러오는 데 실패했습니다.');
          },
        );
      }

      function clearPrivateListeners() {
        if (userListenerUnsubscribe) {
          userListenerUnsubscribe();
          userListenerUnsubscribe = null;
        }
        if (supportTypesListenerUnsubscribe) {
          supportTypesListenerUnsubscribe();
          supportTypesListenerUnsubscribe = null;
        }
        if (recordsListenerUnsubscribe) {
          recordsListenerUnsubscribe();
          recordsListenerUnsubscribe = null;
        }
        if (setupUiListenerController) {
          setupUiListenerController.abort();
          setupUiListenerController = null;
        }
        appEventListenersAttached = false;
      }

      let publicListenersAttached = false;
      function setupPublicListeners() {
        if (publicListenersAttached) {
          console.log('[setupPublicListeners] Already attached, skipping');
          return;
        }
        publicListenersAttached = true;

        if (appConfigListenerUnsubscribe) appConfigListenerUnsubscribe();
        appConfigListenerUnsubscribe = SettingsService.watchAppConfig((docSnap) => {
          if (docSnap.exists() && docSnap.data().logoUrl) {
            const logoUrl = docSnap.data().logoUrl;
            document.querySelectorAll('.app-logo').forEach((img) => {
              img.src = logoUrl;
            });
          }
        });

        if (announcementListenerUnsubscribe) announcementListenerUnsubscribe();
        announcementListenerUnsubscribe = SettingsService.watchAnnouncement((docSnap) => {
          const banner = document.getElementById('announcement-banner');
          const content = document.getElementById('announcement-content');
          if (!banner || !content) {
            console.warn('[setupPublicListeners] Announcement elements not found');
            return;
          }
          if (docSnap.exists() && docSnap.data().message && docSnap.data().active) {
            content.textContent = docSnap.data().message;
            banner.classList.remove('hidden');
          } else {
            banner.classList.add('hidden');
          }
        });
      }

      // --- Authentication & Profile Management ---
      function handleLogin() {
        const email = document.getElementById('loginEmailInput').value;
        const password = document.getElementById('loginPasswordInput').value;
        const button = document.getElementById('loginButton');
        button.disabled = true;
        button.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>로그인 중...`;
        try {
          AuthService.login(email, password)
            .then(() => {
              document.getElementById('authModal').classList.add('hidden');
            })
            .catch((error) => {
              showAuthMessage(error.message, 'loginMessage');
              document.getElementById('authModal').classList.remove('hidden');
            })
            .finally(() => {
              button.disabled = false;
              button.innerHTML = '로그인';
            });
        } catch (error) {
          showAuthMessage(error.message, 'loginMessage');
          document.getElementById('authModal').classList.remove('hidden');
          button.disabled = false;
          button.innerHTML = '로그인';
        }
      }

      function handleSignup() {
        const email = document.getElementById('signupEmailInput').value;
        const password = document.getElementById('signupPasswordInput').value;
        const name = document.getElementById('signupNameInput').value;
        const button = document.getElementById('signupButton');
        const signupMessage = document.getElementById('signupMessage');

        if (!name) {
          showAuthMessage('이름을 입력해주세요.', 'signupMessage');
          return;
        }
        button.disabled = true;
        button.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>가입 중...`;
        try {
          AuthService.signup(email, password)
            .then((userCredential) => {
              const user = userCredential.user;
              const signupUser = new UserModel({
                uid: user.uid,
                email,
                displayName: name,
                role: 'user',
                status: 'active',
                createdAt: serverTimestamp(),
                lastLogin: serverTimestamp(),
              });
              return UserService.upsertUser(user.uid, signupUser.toFirestore());
            })
            .then(() => {
              document.getElementById('signupModal').classList.add('hidden');
            })
            .catch((error) => {
              showAuthMessage(error.message, 'signupMessage');
              document.getElementById('signupModal').classList.remove('hidden');
            })
            .finally(() => {
              button.disabled = false;
              button.innerHTML = '회원가입';
            });
        } catch (error) {
          showAuthMessage(error.message, 'signupMessage');
          document.getElementById('signupModal').classList.remove('hidden');
          button.disabled = false;
          button.innerHTML = '회원가입';
        }
      }

      async function handleLogout() {
        clearPrivateListeners();
        await AuthService.signOut();

        // 수정: 로그아웃 후 로그인/회원가입 모달의 위치를 중앙으로 재설정
        const authModalContent = document.querySelector('#authModal .modal-content');
        if (authModalContent) {
          resetModalPosition(authModalContent);
        }
        const signupModalContent = document.querySelector('#signupModal .modal-content');
        if (signupModalContent) {
          resetModalPosition(signupModalContent);
        }
        // 수정: 로그아웃 시 페이지네이션 관련 전역 변수 초기화
        AppState.resetPagination();
      }

      function showAuthMessage(message, elementId) {
        const authMessage = document.getElementById(elementId);
        authMessage.textContent = message;
        const parentModal = authMessage.closest('.modal-overlay');
        if (parentModal) {
          parentModal.classList.remove('hidden');
        }
        authMessage.classList.remove('hidden');
      }

      function openProfileModal() {
        closeFullCalendarPopovers();
        const profileModal = document.getElementById('profileModal');
        if (!profileModal.innerHTML) {
          profileModal.innerHTML = `
                <div class="modal-content card">
                    <div class="modal-header">
                        <h3 class="text-xl font-bold">내 정보 수정</h3>
                        <button id="closeProfileModalButton" class="text-2xl hover:text-red-500">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p class="text-sm text-gray-700 dark:text-gray-300 mb-6">표시될 이름을 수정하고 비밀번호를 변경할 수 있습니다.</p>
                        <div>
                            <label for="profileNameInput" class="block text-sm font-medium text-gray-800 dark:text-white mb-1">이름</label>
                            <input type="text" id="profileNameInput" name="profileName" class="form-input mt-1 block w-full px-4 py-2.5" required autocomplete="name">
                        </div>
                        <div class="mt-6">
                            <button id="changePasswordButton" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">비밀번호 변경</button>
                        </div>
                        <div id="passwordChangeSection" class="hidden mt-4 space-y-4">
                            <div>
                                <label for="currentPasswordInput" class="block text-sm font-medium text-gray-800 dark:text-white mb-1">현재 비밀번호</label>
                                <input type="password" id="currentPasswordInput" name="currentPassword" class="form-input mt-1 block w-full px-4 py-2.5" autocomplete="current-password">
                            </div>
                            <div>
                                <label for="newPasswordInput" class="block text-sm font-medium text-gray-800 dark:text-white mb-1">새 비밀번호</label>
                                <input type="password" id="newPasswordInput" name="newPassword" class="form-input mt-1 block w-full px-4 py-2.5" autocomplete="new-password">
                            </div>
                            <div>
                                <label for="confirmPasswordInput" class="block text-sm font-medium text-gray-800 dark:text-white mb-1">새 비밀번호 확인</label>
                                <input type="password" id="confirmPasswordInput" name="confirmPassword" class="form-input mt-1 block w-full px-4 py-2.5" autocomplete="new-password">
                            </div>
                        </div>
                        <div id="profileMessage" class="mt-4 text-sm text-red-600"></div>
                        <div class="flex justify-end gap-4 mt-6">
                            <button id="closeProfileModalButton2" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm hover:bg-gray-50 dark:hover:bg-gray-700 interactive-button">취소</button>
                            <button id="saveProfileButton" class="px-4 py-2 border border-transparent rounded-lg shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 interactive-button">저장</button>
                        </div>
                    </div>
                </div>`;
          profileModal
            .querySelector('#closeProfileModalButton')
            .addEventListener('click', () => profileModal.classList.add('hidden'));
          profileModal
            .querySelector('#closeProfileModalButton2')
            .addEventListener('click', () => profileModal.classList.add('hidden'));
          profileModal
            .querySelector('#saveProfileButton')
            .addEventListener('click', handleProfileUpdate);
          profileModal.querySelector('#changePasswordButton').addEventListener('click', () => {
            document.getElementById('passwordChangeSection').classList.toggle('hidden');
          });
          const profileModalContent = profileModal.querySelector('.modal-content');
          if (profileModalContent) {
            makeModalDraggable(profileModalContent);
          }
        }

        const profileNameInput = profileModal.querySelector('#profileNameInput');
        profileNameInput.value = currentUser.displayName;
        profileModal.classList.remove('hidden');
        const profileModalContent = profileModal.querySelector('.modal-content');
        if (profileModalContent) {
          resetModalPosition(profileModalContent);
        }
      }

      async function handleProfileUpdate() {
        const profileModal = document.getElementById('profileModal');
        const newName = profileModal.querySelector('#profileNameInput').value.trim();
        const profileMessage = profileModal.querySelector('#profileMessage');
        const saveButton = profileModal.querySelector('#saveProfileButton');

        if (!newName) {
          profileMessage.textContent = '이름을 입력해주세요.';
          return;
        }
        profileMessage.textContent = '';
        saveButton.disabled = true;
        saveButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>저장 중...`;

        try {
          if (newName !== currentUser.displayName) {
            const userDocRef = doc(db, 'users', currentUser.uid);
            const previousDisplayName = currentUser.displayName;
            const workLogsRef = collection(db, 'work_logs');
            const q = query(workLogsRef, where('submittedBy', '==', currentUser.uid));
            const querySnapshot = await getDocs(q);
            const docsToUpdate = querySnapshot.docs.map((snapshotDoc) => ({
              ref: snapshotDoc.ref,
              previousName: snapshotDoc.data().name || '',
            }));
            const chunkSize = 500;
            const committedChunks = [];

            try {
              for (let i = 0; i < docsToUpdate.length; i += chunkSize) {
                const chunk = docsToUpdate.slice(i, i + chunkSize);
                const updateBatch = writeBatch(db);
                chunk.forEach((entry) => {
                  updateBatch.update(entry.ref, { name: newName });
                });
                await updateBatch.commit();
                committedChunks.push(chunk);
              }

              await setDoc(userDocRef, { displayName: newName }, { merge: true });
              currentUser.displayName = newName;
            } catch (nameUpdateError) {
              for (let i = committedChunks.length - 1; i >= 0; i--) {
                const rollbackBatch = writeBatch(db);
                committedChunks[i].forEach((entry) => {
                  rollbackBatch.update(entry.ref, { name: entry.previousName });
                });
                await rollbackBatch.commit();
              }
              await setDoc(userDocRef, { displayName: previousDisplayName }, { merge: true });
              throw new Error('이름 변경 중 오류가 발생하여 이전 상태로 복원했습니다.');
            }

            showToast('success', '이름이 성공적으로 변경되었습니다.');
          }

          const currentPassword = document.getElementById('currentPasswordInput').value;
          const newPassword = document.getElementById('newPasswordInput').value;
          const confirmPassword = document.getElementById('confirmPasswordInput').value;

          if (currentPassword && newPassword) {
            if (newPassword !== confirmPassword) {
              throw new Error('새 비밀번호가 일치하지 않습니다.');
            }
            if (newPassword.length < 6) {
              throw new Error('비밀번호는 6자 이상이어야 합니다.');
            }

            const user = auth.currentUser;
            const credential = EmailAuthProvider.credential(user.email, currentPassword);
            await reauthenticateWithCredential(user, credential);
            await updatePassword(user, newPassword);
            showToast('success', '비밀번호가 성공적으로 변경되었습니다.');
          }

          profileModal.classList.add('hidden');
        } catch (error) {
          console.error('Error updating profile: ', error);
          profileMessage.textContent = `오류: ${error.message}`;
          showToast('error', `프로필 업데이트 오류: ${error.message}`);
        } finally {
          saveButton.disabled = false;
          saveButton.innerHTML = '저장';
        }
      }

      // --- Work Log Form & Data Handling ---
      function calculateSupportHours() {
        const departureTimeStr = document.querySelector('#workLogModal #departureTime').value;
        const arrivalTimeStr = document.querySelector('#workLogModal #arrivalTime').value;
        const workStartTimeStr = document.querySelector('#workLogModal #startTime').value;
        const workEndTimeStr = document.querySelector('#workLogModal #endTime').value;
        const supportHoursInput = document.querySelector('#workLogModal #supportHours');

        let travelHours = 0;
        let workHours = 0;

        const getAdjustedTimeRange = (startTimeStr, endTimeStr) => {
          const start = Utils.parseTimeToDate(startTimeStr);
          const end = Utils.parseTimeToDate(endTimeStr);
          if (end <= start) {
            end.setDate(end.getDate() + 1);
          }
          return { start, end };
        };

        if (departureTimeStr && arrivalTimeStr) {
          const { start: departure, end: arrival } = getAdjustedTimeRange(
            departureTimeStr,
            arrivalTimeStr,
          );
          travelHours = (arrival - departure) / 1000 / 60 / 60;
        }

        if (workStartTimeStr && workEndTimeStr) {
          const { start: workStart, end: workEnd } = getAdjustedTimeRange(
            workStartTimeStr,
            workEndTimeStr,
          );
          workHours = (workEnd - workStart) / 1000 / 60 / 60;

          const lunchStart = new Date(`1970-01-01T${CONFIG.LUNCH_START}`);
          const lunchEnd = new Date(`1970-01-01T${CONFIG.LUNCH_END}`);

          if (workStart < lunchEnd && workEnd > lunchStart) {
            const overlapStart = Math.max(workStart.getTime(), lunchStart.getTime());
            const overlapEnd = Math.min(workEnd.getTime(), lunchEnd.getTime());

            if (overlapEnd > overlapStart) {
              const overlapHours = (overlapEnd - overlapStart) / 1000 / 60 / 60;
              workHours -= overlapHours;
            }
          }
        }

        let totalHours = travelHours + workHours;

        supportHoursInput.value = totalHours > 0 ? Math.max(0, totalHours).toFixed(2) : '';
      }

      function clearTimes() {
        document.querySelector('#workLogModal #departureTime').value = '';
        document.querySelector('#workLogModal #arrivalTime').value = '';
        document.querySelector('#workLogModal #startTime').value = '';
        document.querySelector('#workLogModal #endTime').value = '';
        calculateSupportHours();
      }

      function updateClientDatalist(records) {
        const clientList = document.querySelector('#workLogModal #client-list');
        if (!clientList) return;
        const uniqueClients = [...new Set(records.map((rec) => rec.client).filter(Boolean))];
        clientList.innerHTML = uniqueClients
          .map((client) => `<option value="${client}"></option>`)
          .join('');
      }

      async function handleFormSubmit(e) {
        e.preventDefault();
        const form = e.target;
        const submitButton = form.querySelector('#submitButton');
        const isTemplateEditMode = form.hasAttribute('data-template-id');

        if (!isTemplateEditMode && !validateForm()) {
          showToast('error', '필수 항목을 모두 입력해주세요.');
          return;
        }

        submitButton.disabled = true;
        submitButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>처리 중...`;

        try {
          if (isTemplateEditMode) {
            // 템플릿 수정 모드
            const templateData = TemplateModel.fromForm(form).toFirestore();
            await TemplateService.save(currentUser.uid, form.dataset.templateId, templateData);
            showToast('success', '템플릿이 성공적으로 수정되었습니다.');
            form.removeAttribute('data-template-id');
            form.removeAttribute('data-template-name');
            openTemplateModal();
          } else {
            // 일반적인 업무 등록 및 수정 모드
            form.removeAttribute('data-template-id');
            form.removeAttribute('data-template-name');
            const recordData = WorkLogModel.fromForm(form, currentUser.uid).toFirestore();

            if (editingRecordId) {
              // 수정 권한 확인
              const recordDoc = allRecords.find((r) => r.id === editingRecordId);
              if (
                !recordDoc ||
                (recordDoc.submittedBy !== currentUser.uid && currentUser.role !== 'admin')
              ) {
                showToast('error', '자신이 작성한 기록만 수정할 수 있습니다.');
                submitButton.disabled = false;
                submitButton.innerHTML = '기록 제출';
                return;
              }

              await WorkLogService.update(editingRecordId, recordData, { merge: true });
              showToast('success', '기록이 성공적으로 수정되었습니다.');
              cancelEdit();
            } else {
              await WorkLogService.create(recordData);
              showToast('success', '기록이 성공적으로 제출되었습니다.');
              cancelEdit();
            }

            if (editingRecordId) {
              applyAllFilters();
            } else {
              applyAllFilters();
            }
          }
        } catch (error) {
          console.error('Error submitting form:', error);
          showToast('error', '제출 중 오류가 발생했습니다.');
        } finally {
          submitButton.disabled = false;
          submitButton.innerHTML = '기록 제출';
        }
      }

      async function handleDelete(recordId) {
        // 삭제 권한 확인
        const recordDoc = allRecords.find((r) => r.id === recordId);
        if (
          !recordDoc ||
          (recordDoc.submittedBy !== currentUser.uid && currentUser.role !== 'admin')
        ) {
          showToast('error', '자신이 작성한 기록만 삭제할 수 있습니다.');
          return;
        }

        if (!(await showConfirmModal('정말로 이 기록을 삭제하시겠습니까?'))) return;

        try {
          await WorkLogService.delete(recordId);
          showToast('success', '기록이 삭제되었습니다.');
          applyAllFilters();
        } catch (error) {
          console.error('Error deleting record:', error);
          showToast('error', '삭제 중 오류가 발생했습니다.');
        }
      }

      async function handleDeleteSelected() {
        const checkboxes = document.querySelectorAll('#recordsTableBody .record-checkbox:checked');
        if (checkboxes.length === 0) {
          showToast('info', '삭제할 항목을 선택하세요.');
          return;
        }

        const selectedRecordIds = Array.from(checkboxes).map(
          (checkbox) => checkbox.closest('tr').dataset.id,
        );

        // 삭제 권한 확인
        if (currentUser.role !== 'admin') {
          const canDeleteAll = selectedRecordIds.every((id) => {
            const recordDoc = allRecords.find((r) => r.id === id);
            return recordDoc && recordDoc.submittedBy === currentUser.uid;
          });

          if (!canDeleteAll) {
            showToast('error', '자신이 작성한 기록만 삭제할 수 있습니다.');
            return;
          }
        }

        if (!(await showConfirmModal(`${checkboxes.length}개의 기록을 정말로 삭제하시겠습니까?`)))
          return;

        const batch = writeBatch(db);
        selectedRecordIds.forEach((recordId) => {
          const docRef = doc(db, 'work_logs', recordId);
          batch.delete(docRef);
        });

        try {
          await batch.commit();
          showToast('success', `${checkboxes.length}개의 기록이 삭제되었습니다.`);
          applyAllFilters();
        } catch (error) {
          console.error('Error deleting selected records: ', error);
          showToast('error', '선택된 항목 삭제 중 오류가 발생했습니다.');
        }
      }

      function handleEdit(recordId, recordData) {
        // 수정 권한 확인
        if (recordData.submittedBy !== currentUser.uid && currentUser.role !== 'admin') {
          showToast('error', '자신이 작성한 기록만 수정할 수 있습니다.');
          return;
        }

        closeFullCalendarPopovers();
        editingRecordId = recordId;
        const workLogModal = document.getElementById('workLogModal');
        const workLogForm = document.getElementById('workLogForm');
        const submitButton = workLogForm.querySelector('#submitButton');
        const cancelEditButton = workLogForm.querySelector('#cancelEditButton');

        workLogForm.removeAttribute('data-template-id');
        workLogForm.removeAttribute('data-template-name');

        if (datePicker) datePicker.setDate(recordData.date, true);
        workLogForm.name.value = recordData.name;
        workLogForm.client.value = recordData.client;
        workLogForm.place.value = recordData.place;
        workLogForm.supportType.value = recordData.supportType;
        workLogForm.departureTime.value = recordData.departureTime;
        workLogForm.arrivalTime.value = recordData.arrivalTime;
        workLogForm.startTime.value = recordData.startTime;
        workLogForm.endTime.value = recordData.endTime;
        workLogForm.supportHours.value = recordData.supportHours;
        workLogForm.details.value = recordData.details;

        submitButton.textContent = '기록 수정';
        cancelEditButton.classList.remove('hidden');
        workLogModal.classList.remove('hidden');

        workLogForm.querySelector('#clearTimesButton').classList.remove('hidden');

        const workLogModalContent = workLogModal.querySelector('.modal-content');
        if (workLogModalContent) {
          resetModalPosition(workLogModalContent);
        }
      }

      function cancelEdit() {
        const modal = document.getElementById('workLogModal');
        const form = document.getElementById('workLogForm');
        const submitButton = form.querySelector('#submitButton');
        const cancelEditButton = form.querySelector('#cancelEditButton');
        const clearTimesButton = form.querySelector('#clearTimesButton');

        editingRecordId = null;
        form.reset();
        form.removeAttribute('data-template-id');
        form.removeAttribute('data-template-name');
        form.querySelectorAll('.is-invalid').forEach((el) => {
          el.classList.remove('is-invalid');
        });
        form.querySelectorAll('.form-error-message').forEach((el) => {
          el.classList.add('hidden');
        });
        if (datePicker) datePicker.setDate('today', true);

        document.querySelector('#workLogModal #name').value = currentUser.displayName;
        submitButton.textContent = '기록 제출';
        cancelEditButton.classList.add('hidden');

        if (clearTimesButton) {
          clearTimesButton.classList.remove('hidden');
        }

        modal.classList.add('hidden');
        const modalContent = modal.querySelector('.modal-content');
        if (modalContent) {
          resetModalPosition(modalContent);
        }
      }

      // --- Display & UI Rendering ---
      function handleTableActions(e) {
        const button = e.target.closest('button');
        if (!button) return;

        const row = button.closest('tr');
        if (!row) return;
        const recordId = row.dataset.id;
        const recordData = JSON.parse(row.dataset.record);

        if (button.classList.contains('delete-btn')) {
          handleDelete(recordId);
        } else if (button.classList.contains('edit-btn')) {
          handleEdit(recordId, recordData);
        }
      }

      function renderRecords(docs) {
        const tableBody = document.getElementById('recordsTableBody');
        const selectAllHeader = document.getElementById('selectAllHeader');
        const deleteSelectedButton = document.getElementById('deleteSelectedButton');
        const isAdmin = currentUser && currentUser.role === 'admin';

        if (isAdmin) {
          if (selectAllHeader) {
            selectAllHeader.style.display = '';
          }
          if (deleteSelectedButton) {
            deleteSelectedButton.classList.remove('hidden');
          }
        } else {
          if (selectAllHeader) {
            selectAllHeader.style.display = 'none';
          }
          if (deleteSelectedButton) {
            deleteSelectedButton.classList.add('hidden');
          }
        }

        tableBody.innerHTML = '';
        if (!docs || docs.length === 0) {
          const colspan = isAdmin ? '8' : '7';
          tableBody.innerHTML = `<tr><td colspan="${colspan}" class="text-center py-12 text-gray-700 dark:text-gray-300">
                    <i class="fas fa-file-alt fa-3x text-gray-300 dark:text-gray-600"></i>
                    <p class="mt-4">표시할 기록이 없습니다.</p>
                    <p class="text-sm">첫 기록을 추가해보세요!</p>
                </td></tr>`;
          return;
        }
        docs.forEach((data) => {
          const row = document.createElement('tr');
          row.dataset.id = data.id;
          row.dataset.record = JSON.stringify(data);
          row.classList.add(
            'transition-colors',
            'duration-200',
            'hover:bg-gray-50',
            'dark:hover:bg-gray-700/50',
          );

          const canModify =
            currentUser && (currentUser.role === 'admin' || currentUser.uid === data.submittedBy);

          if (isAdmin) {
            const checkboxCell = document.createElement('td');
            checkboxCell.className = 'px-4 py-3 align-middle';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className =
              'record-checkbox h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500';
            checkboxCell.appendChild(checkbox);
            row.appendChild(checkboxCell);
          }

          const dateCell = document.createElement('td');
          dateCell.dataset.label = '일자';
          dateCell.className = 'px-4 py-3 whitespace-nowrap align-middle';
          dateCell.textContent = data.date || '';
          row.appendChild(dateCell);

          const nameCell = document.createElement('td');
          nameCell.dataset.label = '이름';
          nameCell.className = 'px-4 py-3 whitespace-nowrap align-middle';
          nameCell.textContent = data.name || '';
          row.appendChild(nameCell);

          const clientCell = document.createElement('td');
          clientCell.dataset.label = '고객사명';
          clientCell.className = 'px-4 py-3 whitespace-nowrap align-middle';
          clientCell.textContent = data.client || '';
          row.appendChild(clientCell);

          const detailsCell = document.createElement('td');
          detailsCell.dataset.label = '지원내용';
          detailsCell.className = 'px-4 py-3 align-middle';
          detailsCell.style.whiteSpace = 'pre-wrap';
          detailsCell.style.wordBreak = 'break-word';
          detailsCell.textContent = data.details || '';
          row.appendChild(detailsCell);

          const timeCell = document.createElement('td');
          timeCell.dataset.label = '지원시간';
          timeCell.className = 'px-4 py-3 whitespace-nowrap align-middle';
          timeCell.textContent = `${data.startTime || ''} - ${data.endTime || ''}`;
          row.appendChild(timeCell);

          const hoursCell = document.createElement('td');
          hoursCell.dataset.label = '총 시간(H)';
          hoursCell.className = 'px-4 py-3 whitespace-nowrap align-middle';
          hoursCell.textContent = data.supportHours || '';
          row.appendChild(hoursCell);

          const actionsCell = document.createElement('td');
          actionsCell.dataset.label = '액션';
          actionsCell.className = 'actions-cell px-4 py-3 align-middle';
          const actionsWrapper = document.createElement('div');
          actionsWrapper.className = 'flex items-center justify-end gap-x-2';

          if (canModify) {
            const editButton = document.createElement('button');
            editButton.className = 'edit-btn text-indigo-500 hover:text-indigo-700 p-1';
            editButton.title = '수정';
            editButton.innerHTML = '<i class="fas fa-edit"></i>';

            const deleteButton = document.createElement('button');
            deleteButton.className = 'delete-btn text-red-500 hover:text-red-700 p-1';
            deleteButton.title = '삭제';
            deleteButton.innerHTML = '<i class="fas fa-trash"></i>';

            actionsWrapper.appendChild(editButton);
            actionsWrapper.appendChild(deleteButton);
          }

          actionsCell.appendChild(actionsWrapper);
          row.appendChild(actionsCell);
          tableBody.appendChild(row);
        });

        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        if (selectAllCheckbox) {
          selectAllCheckbox.checked = false;
        }
      }

      function renderSkeleton(count) {
        const tableBody = document.getElementById('recordsTableBody');
        const isAdmin = currentUser && currentUser.role === 'admin';
        const colspan = isAdmin ? 8 : 7;

        tableBody.innerHTML = '';
        if (count === 0) {
          tableBody.innerHTML = `<tr><td colspan="${colspan}" class="text-center py-12 text-gray-700 dark:text-gray-300">
                    <i class="fas fa-file-alt fa-3x text-gray-300 dark:text-gray-600"></i>
                    <p class="mt-4">표시할 기록이 없습니다.</p>
                    <p class="text-sm">첫 기록을 추가해보세요!</p>
                </td></tr>`;
          return;
        }
        for (let i = 0; i < count; i++) {
          let rowHtml = '';
          if (isAdmin) {
            rowHtml += `<td class="px-4 py-3 align-middle"><div class="skeleton h-5 w-5"></div></td>`;
          }
          rowHtml += `
                    <td class="px-4 py-3"><div class="skeleton h-5 w-24"></div></td>
                    <td class="px-4 py-3"><div class="skeleton h-5 w-16"></div></td>
                    <td class="px-4 py-3"><div class="skeleton h-5 w-20"></div></td>
                    <td class="px-4 py-3"><div class="skeleton h-5 w-40"></div></td>
                    <td class="px-4 py-3"><div class="skeleton h-5 w-24"></div></td>
                    <td class="px-4 py-3"><div class="skeleton h-5 w-10"></div></td>
                    <td class="px-4 py-3"><div class="flex justify-end gap-x-2"><div class="skeleton h-8 w-8"></div><div class="skeleton h-8 w-8"></div></div></td>
                `;
          tableBody.innerHTML += `<tr>${rowHtml}</tr>`;
        }
      }

      function applyAllFilters(preservePage = false) {
        if (!currentUser) return;
        const filteredData = getUiFilteredData();
        const direction = preservePage ? 'stay' : null;
        fetchWorkLogs(direction, filteredData);
        updateDashboard();
        updateCalendarEvents();
      }

      function getUiFilteredData() {
        let data = [...allRecords];
        const searchTerm = document.getElementById('unifiedSearchInput').value.toLowerCase();
        if (searchTerm) {
          data = data.filter(
            (rec) =>
              (rec.client || '').toLowerCase().includes(searchTerm) ||
              (rec.name || '').toLowerCase().includes(searchTerm) ||
              (rec.details || '').toLowerCase().includes(searchTerm),
          );
        }
        const showOnlyMyRecords = document.getElementById('myRecordsFilter').checked;
        if (showOnlyMyRecords) {
          data = data.filter((rec) => rec.submittedBy === currentUser.uid);
        }
        return data;
      }

      function getDashboardFilteredData(personal = false) {
        let data = [...allRecords];
        const selectedMonth = document.getElementById('dashboardMonthFilter').value;
        if (selectedMonth) {
          data = data.filter((rec) => rec.date && rec.date.startsWith(selectedMonth));
        }
        if (personal) {
          data = data.filter((rec) => rec.submittedBy === currentUser.uid);
        }
        return data;
      }

      function fetchWorkLogs(direction = null, sourceData = getUiFilteredData()) {
        renderSkeleton(CONFIG.RECORDS_PER_PAGE);

        try {
          let filteredRecords = sourceData;

          filteredRecords.sort((a, b) => {
            if (a.date > b.date) return -1;
            if (a.date < b.date) return 1;
            const timeA = a.timestamp?.toMillis ? a.timestamp.toMillis() : 0;
            const timeB = b.timestamp?.toMillis ? b.timestamp.toMillis() : 0;
            return timeB - timeA;
          });

          const totalRecords = filteredRecords.length;
          const totalPages = Math.ceil(totalRecords / CONFIG.RECORDS_PER_PAGE) || 1;

          if (direction === 'next') {
            currentPage++;
          } else if (direction === 'prev') {
            currentPage--;
          } else if (direction !== 'stay') {
            currentPage = 1;
          }

          currentPage = Math.max(1, Math.min(currentPage, totalPages));

          const startIndex = (currentPage - 1) * CONFIG.RECORDS_PER_PAGE;
          const endIndex = startIndex + CONFIG.RECORDS_PER_PAGE;
          const paginatedRecords = filteredRecords.slice(startIndex, endIndex);

          renderRecords(paginatedRecords);
          updatePaginationControls(totalRecords, totalPages);
        } catch (error) {
          console.error('Error fetching work logs:', error);
          showToast('error', '데이터를 불러오는 중 오류가 발생했습니다.');
          renderRecords([]);
        }
      }

      function goToPage(page) {
        currentPage = page;
        fetchWorkLogs('stay');
      }

      // --- Pagination ---
      function updatePaginationControls(totalRecords, totalPages) {
        const paginationControls = document.getElementById('paginationControls');
        paginationControls.innerHTML = '';

        if (totalPages <= 1) return;

        const createButton = (text, page, isDisabled = false, isActive = false) => {
          const button = document.createElement('button');
          button.innerHTML = text;
          button.className = 'page-link';
          if (isActive) button.classList.add('active');
          if (isDisabled) {
            button.classList.add('disabled');
            button.disabled = true;
          } else {
            button.addEventListener('click', () => {
              if (text === '&laquo;') goToPage(currentPage - 1);
              else if (text === '&raquo;') goToPage(currentPage + 1);
              else goToPage(page);
            });
          }
          return button;
        };

        const createEllipsis = () => {
          const ellipsis = document.createElement('span');
          ellipsis.textContent = '...';
          ellipsis.className = 'page-ellipsis';
          return ellipsis;
        };

        paginationControls.appendChild(createButton('&laquo;', null, currentPage === 1));

        const maxVisibleButtons = 5;
        if (totalPages <= maxVisibleButtons) {
          for (let i = 1; i <= totalPages; i++) {
            paginationControls.appendChild(createButton(i, i, false, i === currentPage));
          }
        } else {
          let startPage, endPage;
          if (currentPage <= 3) {
            startPage = 1;
            endPage = maxVisibleButtons - 1;
          } else if (currentPage + 2 >= totalPages) {
            startPage = totalPages - (maxVisibleButtons - 2);
            endPage = totalPages;
          } else {
            startPage = currentPage - 1;
            endPage = currentPage + 1;
          }

          if (startPage > 1) {
            paginationControls.appendChild(createButton(1, 1));
            if (startPage > 2) {
              paginationControls.appendChild(createEllipsis());
            }
          }

          for (let i = startPage; i <= endPage; i++) {
            if (i > 0 && i <= totalPages) {
              paginationControls.appendChild(createButton(i, i, false, i === currentPage));
            }
          }

          if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
              paginationControls.appendChild(createEllipsis());
            }
            paginationControls.appendChild(createButton(totalPages, totalPages));
          }
        }

        paginationControls.appendChild(createButton('&raquo;', null, currentPage === totalPages));
      }

      // --- Dashboard ---
      function updateDashboard() {
        const toggleContainer = document.getElementById('dashboardToggleContainer');

        if (currentUser && currentUser.role === 'admin') {
          // 관리자는 토글 없이 팀 대시보드만 표시
          toggleContainer.classList.add('hidden');
          switchDashboard('team');
        } else {
          // 일반 사용자는 토글 표시
          toggleContainer.classList.remove('hidden');
          const isPersonal = document
            .getElementById('personalDashboardToggle')
            .classList.contains('shadow');
          const isTeam = document
            .getElementById('teamDashboardToggle')
            .classList.contains('shadow');

          if (!isPersonal && !isTeam) {
            switchDashboard('personal');
          } else {
            switchDashboard(isPersonal ? 'personal' : 'team');
          }
        }
      }

      function switchDashboard(type) {
        const teamToggle = document.getElementById('teamDashboardToggle');
        const personalToggle = document.getElementById('personalDashboardToggle');
        const teamDashboard = document.getElementById('teamDashboard');
        const personalDashboard = document.getElementById('personalDashboard');

        if (type === 'team') {
          teamDashboard.classList.remove('hidden');
          personalDashboard.classList.add('hidden');
          teamToggle.classList.add('bg-white', 'dark:bg-gray-500', 'shadow');
          personalToggle.classList.remove('bg-white', 'dark:bg-gray-500', 'shadow');
          renderDashboardCharts(false);
        } else {
          teamDashboard.classList.add('hidden');
          personalDashboard.classList.remove('hidden');
          personalToggle.classList.add('bg-white', 'dark:bg-gray-500', 'shadow');
          teamToggle.classList.remove('bg-white', 'dark:bg-gray-500', 'shadow');
          renderDashboardCharts(true);
        }
      }

      function renderDashboardCharts(personal = false) {
        const container = document.getElementById(personal ? 'personalDashboard' : 'teamDashboard');
        const selectedMonthStr = document.getElementById('dashboardMonthFilter').value;
        const selectedMonthLabel = selectedMonthStr
          ? `${selectedMonthStr.replace('-', '.')} 기준`
          : '전체 기간';
        container.className = 'grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-5';

        container.innerHTML = `
                <div class="dashboard-kpi-card card p-6 group transition-all duration-300 hover:-translate-y-1"></div>
                <div class="dashboard-kpi-card card p-6 group transition-all duration-300 hover:-translate-y-1"></div>
                <div class="dashboard-kpi-card card p-6 group transition-all duration-300 hover:-translate-y-1"></div>
                <div class="dashboard-kpi-card card p-6 group transition-all duration-300 hover:-translate-y-1"></div>
                <div class="dashboard-chart-panel card p-5 sm:p-6 col-span-1 md:col-span-2 xl:col-span-4">
                    <div class="flex flex-wrap justify-between items-center gap-3 mb-4">
                        <div>
                            <p class="text-xs font-bold uppercase tracking-[0.18em] text-slate-500 dark:text-slate-400">Client Insights</p>
                            <h4 class="text-lg sm:text-xl font-bold text-slate-900 dark:text-white">상위 지원 고객사 현황</h4>
                        </div>
                        <span class="dashboard-month-badge"><i class="fas fa-calendar-week"></i>${selectedMonthLabel}</span>
                    </div>
                    <canvas id="${personal ? 'personalClientChart' : 'teamClientChart'}" style="max-height: 350px;"></canvas>
                </div>
            `;

        const currentMonthData = getDashboardFilteredData(personal);

        const [year, month] = selectedMonthStr
          ? selectedMonthStr.split('-').map(Number)
          : [new Date().getFullYear(), new Date().getMonth() + 1];
        const prevMonthDate = new Date(year, month - 2, 1);
        const prevMonthStr = `${prevMonthDate.getFullYear()}-${String(prevMonthDate.getMonth() + 1).padStart(2, '0')}`;

        let prevMonthData = allRecords.filter(
          (rec) => rec.date && rec.date.startsWith(prevMonthStr),
        );
        if (personal) {
          prevMonthData = prevMonthData.filter((rec) => rec.submittedBy === currentUser.uid);
        }

        const currentKpis = {
          hours: currentMonthData.reduce((acc, curr) => acc + (Number(curr.supportHours) || 0), 0),
          cases: currentMonthData.length,
          clients: new Set(currentMonthData.map((r) => r.client)).size,
        };
        currentKpis.days = currentKpis.hours / 8;

        const prevKpis = {
          hours: prevMonthData.reduce((acc, curr) => acc + (Number(curr.supportHours) || 0), 0),
          cases: prevMonthData.length,
          clients: new Set(prevMonthData.map((r) => r.client)).size,
        };
        prevKpis.days = prevKpis.hours / 8;

        const getChangeHtml = (current, previous) => {
          if (previous === 0) {
            return current > 0
              ? `<span class="dashboard-kpi-change up">New</span>`
              : `<span class="dashboard-kpi-change neutral">-</span>`;
          }
          const change = ((current - previous) / previous) * 100;
          const isPositive = change >= 0;
          const changeClass = isPositive ? 'up' : 'down';
          const icon = isPositive ? '↑' : '↓';
          return `<span class="dashboard-kpi-change ${changeClass}">${icon} ${Math.abs(change).toFixed(0)}%</span>`;
        };

        const kpiCardsContainer = container.querySelectorAll('.dashboard-kpi-card');

        // KPI 1: Total Hours - Minimal Navy Style
        kpiCardsContainer[0].innerHTML += `
                <div class="dashboard-kpi-header">
                    <div class="dashboard-kpi-icon navy">
                        <i class="fas fa-clock"></i>
                    </div>
                    ${getChangeHtml(currentKpis.hours, prevKpis.hours)}
                </div>
                <h4 class="dashboard-kpi-label">총 지원시간</h4>
                <p class="dashboard-kpi-value">${currentKpis.hours.toFixed(1)}<span class="unit">H</span></p>
            `;

        // KPI 2: Total Days - Minimal Gold Style
        kpiCardsContainer[1].innerHTML += `
                <div class="dashboard-kpi-header">
                    <div class="dashboard-kpi-icon gold">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    ${getChangeHtml(currentKpis.days, prevKpis.days)}
                </div>
                <h4 class="dashboard-kpi-label">총 지원일수</h4>
                <p class="dashboard-kpi-value">${currentKpis.days.toFixed(1)}<span class="unit">Day</span></p>
            `;

        // KPI 3: Total Cases - Minimal Teal Style
        kpiCardsContainer[2].innerHTML += `
                <div class="dashboard-kpi-header">
                    <div class="dashboard-kpi-icon teal">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    ${getChangeHtml(currentKpis.cases, prevKpis.cases)}
                </div>
                <h4 class="dashboard-kpi-label">총 지원건수</h4>
                <p class="dashboard-kpi-value">${currentKpis.cases}<span class="unit">건</span></p>
            `;

        // KPI 4: Active Clients - Minimal Rose Style
        kpiCardsContainer[3].innerHTML += `
                <div class="dashboard-kpi-header">
                    <div class="dashboard-kpi-icon rose">
                        <i class="fas fa-building"></i>
                    </div>
                    ${getChangeHtml(currentKpis.clients, prevKpis.clients)}
                </div>
                <h4 class="dashboard-kpi-label">지원 고객사</h4>
                <p class="dashboard-kpi-value">${currentKpis.clients}<span class="unit">개사</span></p>
            `;

        const clientData = currentMonthData.reduce((acc, curr) => {
          acc[curr.client] = (acc[curr.client] || 0) + 1;
          return acc;
        }, {});

        const sortedClients = Object.entries(clientData)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10); // Increased to 10
        const chartLabels = sortedClients.map((item) => item[0]);
        const chartData = sortedClients.map((item) => item[1]);

        const chartId = personal ? 'personalClientChart' : 'teamClientChart';
        const ctx = document.getElementById(chartId).getContext('2d');

        if (chartInstances[chartId]) {
          chartInstances[chartId].destroy();
        }

        chartInstances[chartId] = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: chartLabels,
            datasets: [
              {
                label: '지원 건수',
                data: chartData,
                backgroundColor: (context) => {
                  const ctx = context.chart.ctx;
                  const gradient = ctx.createLinearGradient(0, 0, 200, 0);
                  gradient.addColorStop(0, 'rgba(16, 42, 67, 0.9)');
                  gradient.addColorStop(1, 'rgba(36, 59, 83, 0.7)');
                  return gradient;
                },
                borderColor: 'rgba(212, 175, 55, 0.5)',
                borderWidth: 1,
                borderRadius: 8,
                borderSkipped: false,
                barThickness: 24,
                hoverBackgroundColor: 'rgba(212, 175, 55, 0.8)',
              },
            ],
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false,
              },
              title: {
                display: false,
              },
              tooltip: {
                backgroundColor: 'rgba(16, 42, 67, 0.95)',
                padding: 16,
                cornerRadius: 12,
                titleFont: { family: 'Pretendard', size: 14, weight: '600' },
                bodyFont: { family: 'Pretendard', size: 13 },
                borderColor: 'rgba(212, 175, 55, 0.3)',
                borderWidth: 1,
                displayColors: false,
                callbacks: {
                  label: function (context) {
                    return context.parsed.x + '건';
                  },
                },
              },
            },
            scales: {
              x: {
                beginAtZero: true,
                grid: {
                  color: document.documentElement.classList.contains('dark')
                    ? 'rgba(255, 255, 255, 0.05)'
                    : 'rgba(16, 42, 67, 0.05)',
                  drawBorder: false,
                },
                ticks: {
                  stepSize: 1,
                  font: { family: 'Pretendard', size: 11 },
                  color: document.documentElement.classList.contains('dark')
                    ? '#94a3b8'
                    : '#64748b',
                },
              },
              y: {
                grid: {
                  display: false,
                },
                ticks: {
                  font: { family: 'Pretendard', weight: '500', size: 12 },
                  color: document.documentElement.classList.contains('dark')
                    ? '#cbd5e1'
                    : '#334155',
                  padding: 12,
                },
              },
            },
            animation: {
              duration: 1000,
              easing: 'easeOutQuart',
            },
          },
        });
      }

      function updateFiscalYearFilter() {
        const filterSelect = document.getElementById('exportMonthFilter');
        if (!filterSelect) return;

        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth();

        const fiscalYearStart = currentMonth < 3 ? currentYear - 1 : currentYear;
        const fiscalYearEnd = fiscalYearStart + 1;

        filterSelect.innerHTML = '';

        const optionAll = document.createElement('option');
        optionAll.value = 'all';
        optionAll.textContent = `전체 (${String(fiscalYearStart).slice(-2)}/04 ~ ${String(fiscalYearEnd).slice(-2)}/03)`;
        filterSelect.appendChild(optionAll);

        for (let i = 0; i < 12; i++) {
          const monthIndex = (i + 3) % 12;
          const year = monthIndex >= 3 ? fiscalYearStart : fiscalYearEnd;
          const month = monthIndex + 1;

          const option = document.createElement('option');
          option.value = `${year}-${String(month).padStart(2, '0')}`;
          option.textContent = `${month}월 (${year})`;
          filterSelect.appendChild(option);
        }
      }

      function exportToCsv() {
        try {
          const searchTerm = document.getElementById('unifiedSearchInput').value.toLowerCase();
          const showOnlyMyRecords = document.getElementById('myRecordsFilter').checked;
          const selectedPeriod = document.getElementById('exportMonthFilter').value;

          let dataToExport = allRecords.filter((rec) => {
            const searchTermMatch =
              !searchTerm ||
              (rec.client || '').toLowerCase().includes(searchTerm) ||
              (rec.name || '').toLowerCase().includes(searchTerm) ||
              (rec.details || '').toLowerCase().includes(searchTerm);

            const myRecordsMatch = !showOnlyMyRecords || rec.submittedBy === currentUser.uid;

            const dateMatch = (() => {
              if (!rec.date) return false;

              if (selectedPeriod === 'all') {
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth();
                const fiscalYearStart = currentMonth < 3 ? currentYear - 1 : currentYear;

                const startDate = `${fiscalYearStart}-04-01`;
                const endDate = `${fiscalYearStart + 1}-03-31`;
                return rec.date >= startDate && rec.date <= endDate;
              } else {
                return rec.date.startsWith(selectedPeriod);
              }
            })();

            return searchTermMatch && myRecordsMatch && dateMatch;
          });

          if (dataToExport.length === 0) {
            showToast('info', '내보낼 데이터가 없습니다. 지정하신 조건에 맞는 기록이 없습니다.');
            return;
          }

          const headers = [
            '일자',
            '이름',
            '고객사',
            '지원유형',
            '출발시간',
            '도착시간',
            '업무시작',
            '업무종료',
            '총지원시간',
            '지원내용',
          ];
          const rows = dataToExport.map((row) => [
            Utils.escapeCsv(sanitizeCsvValue(row.date)),
            Utils.escapeCsv(sanitizeCsvValue(row.name)),
            Utils.escapeCsv(sanitizeCsvValue(row.client)),
            Utils.escapeCsv(sanitizeCsvValue(row.supportType)),
            Utils.escapeCsv(sanitizeCsvValue(row.departureTime)),
            Utils.escapeCsv(sanitizeCsvValue(row.arrivalTime)),
            Utils.escapeCsv(sanitizeCsvValue(row.startTime)),
            Utils.escapeCsv(sanitizeCsvValue(row.endTime)),
            Utils.escapeCsv(sanitizeCsvValue(row.supportHours)),
            Utils.escapeCsv(sanitizeCsvValue(row.details)),
          ]);

          const csvContent =
            CONFIG.CSV_BOM +
            headers.map(Utils.escapeCsv).join(',') +
            '\n' +
            rows.map((e) => e.join(',')).join('\n');

          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          const url = URL.createObjectURL(blob);
          link.setAttribute('href', url);
          const fileName = `customer_support_logs_${new Date().toISOString().slice(0, 10)}.csv`;
          link.setAttribute('download', fileName);
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);

          showToast('success', `${dataToExport.length}개의 기록을 성공적으로 내보냈습니다.`);
        } catch (error) {
          console.error('CSV Export Error:', error);
          showToast('error', 'CSV 파일을 내보내는 중 오류가 발생했습니다.');
        }
      }

      // --- Admin Functions ---
      async function openUserManagementModal() {
        closeFullCalendarPopovers();
        if (!ensureAdminAccess()) {
          return;
        }

        const modal = document.getElementById('userManagementModal');
        modal.innerHTML = `<div class="modal-content card !max-w-4xl"><div class="text-center"><div class="skeleton h-8 w-48 mx-auto"></div></div></div>`;
        modal.classList.remove('hidden');
        const modalContent = modal.querySelector('.modal-content');
        if (modalContent) {
          resetModalPosition(modalContent);
          makeModalDraggable(modalContent);
        }

        try {
          if (!ensureAdminAccess()) {
            modal.classList.add('hidden');
            return;
          }

          const userSnapshot = await UserService.fetchAll();
          const allUsers = userSnapshot.docs.map((snapshotDoc) => ({
            id: snapshotDoc.id,
            ...snapshotDoc.data(),
          }));

          const supportTypesRef = collection(db, 'settings', 'appConfig', 'supportTypes');
          const supportTypesSnapshot = await getDocs(query(supportTypesRef, orderBy('name')));
          const supportTypes = supportTypesSnapshot.docs.map((snapshotDoc) => ({
            id: snapshotDoc.id,
            ...snapshotDoc.data(),
          }));

          const announcementDoc = await getDoc(doc(db, 'settings', 'announcement'));
          const announcement = announcementDoc.exists()
            ? announcementDoc.data()
            : { message: '', active: false };

          modal.innerHTML = `
                    <div class="modal-content card !max-w-4xl">
                        <div class="modal-header">
                            <h3 class="text-2xl font-bold">관리자 설정</h3>
                            <button id="closeUserManagementModal" class="text-2xl hover:text-red-500">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="border-b border-border-color mb-4">
                                <nav class="flex gap-4 -mb-px" id="adminTabs">
                                    <button data-tab="dashboard" class="tab-button p-4 active">대시보드</button>
                                    <button data-tab="users" class="tab-button p-4">사용자 관리</button>
                                    <button data-tab="options" class="tab-button p-4">옵션 관리</button>
                                    <button data-tab="announcement" class="tab-button p-4">공지사항</button>
                                    <button data-tab="holidays" class="tab-button p-4">공휴일 관리</button>
                                </nav>
                            </div>

                            <div id="adminDashboardTab" class="tab-content active"></div>
                            <div id="adminUsersTab" class="tab-content"></div>
                            <div id="adminOptionsTab" class="tab-content"></div>
                            <div id="adminAnnouncementTab" class="tab-content"></div>
                            <div id="adminHolidaysTab" class="tab-content"></div>
                        </div>
                    </div>
                `;

          renderAdminDashboard(allUsers);
          renderUserManagement(allUsers);
          renderOptionsManagement(supportTypes);
          renderAnnouncementManagement(announcement);
          renderHolidaysManagement();

          modal
            .querySelector('#closeUserManagementModal')
            .addEventListener('click', () => modal.classList.add('hidden'));

          const tabs = modal.querySelector('#adminTabs');
          const contents = modal.querySelectorAll('.tab-content');
          tabs.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
              tabs.querySelector('.active').classList.remove('active');
              contents.forEach((content) => {
                content.classList.remove('active');
              });

              e.target.classList.add('active');
              const targetTabId = e.target.dataset.tab;
              modal
                .querySelector(
                  `#admin${targetTabId.charAt(0).toUpperCase() + targetTabId.slice(1)}Tab`,
                )
                .classList.add('active');
            }
          });

          const newModalContent = modal.querySelector('.modal-content');
          if (newModalContent) {
            makeModalDraggable(newModalContent);
          }
        } catch (error) {
          console.error('Error opening user management modal:', error);
          showToast('error', '관리자 설정 창을 여는 데 실패했습니다.');
          modal.classList.add('hidden');
        }
      }

      async function handleLogoUpload(e) {
        if (!ensureAdminAccess()) {
          return;
        }

        const file = e.target.files[0];
        if (!file) {
          showToast('error', '로고 파일을 선택해주세요.');
          return;
        }
        if (file.size > 1024 * 1024) {
          showToast('error', '로고 파일은 1MB를 초과할 수 없습니다.');
          return;
        }

        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = async () => {
          const base64Logo = reader.result;
          try {
            if (!ensureAdminAccess()) {
              return;
            }
            const appConfigRef = doc(db, 'settings', 'appConfig');
            await setDoc(appConfigRef, { logoUrl: base64Logo }, { merge: true });
            showToast('success', '로고가 성공적으로 변경되었습니다.');
          } catch (error) {
            showToast('error', '로고 저장에 실패했습니다.');
            console.error('Error saving logo:', error);
          }
        };
        reader.onerror = (error) => {
          showToast('error', '파일을 읽는 중 오류가 발생했습니다.');
          console.error('File reading error:', error);
        };
      }

      function renderAdminDashboard(allUsers) {
        const container = document.getElementById('adminDashboardTab');
        container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="card p-4 text-center">
                        <h4 class="font-semibold text-gray-800 dark:text-white text-sm">총 사용자 수</h4>
                        <p class="text-4xl font-bold text-gray-800 dark:text-white">${allUsers.length}</p>
                    </div>
                    <div class="card p-4 text-center">
                        <h4 class="font-semibold text-gray-800 dark:text-white text-sm">총 기록 수</h4>
                        <p class="text-4xl font-bold text-gray-800 dark:text-white">${allRecords.length}</p>
                    </div>
                </div>
            `;
      }

      function renderUserManagement(allUsers) {
        const container = document.getElementById('adminUsersTab');
        container.innerHTML = `
                <h4 class="text-lg font-bold mb-4 text-gray-800 dark:text-white">사용자 목록</h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="bg-gray-100 dark:bg-gray-700">
                            <tr>
                                <th class="p-3 text-left">이름</th>
                                <th class="p-3 text-left">이메일</th>
                                <th class="p-3 text-left">역할</th>
                                <th class="p-3 text-left">상태</th>
                            </tr>
                        </thead>
                        <tbody id="adminUsersTableBody" class="divide-y divide-border-color"></tbody>
                    </table>
                </div>
            `;

        const userTableBody = container.querySelector('#adminUsersTableBody');
        allUsers.forEach((user) => {
          const isCurrentUser = user.id === currentUser.uid;

          const row = document.createElement('tr');
          row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700/50';
          row.dataset.userId = user.id;

          const nameCell = document.createElement('td');
          nameCell.className = 'p-3';
          nameCell.textContent = user.displayName || '';

          const emailCell = document.createElement('td');
          emailCell.className = 'p-3';
          emailCell.textContent = user.email || '';

          const roleCell = document.createElement('td');
          roleCell.className = 'p-3';
          const roleActions = document.createElement('div');
          roleActions.className = 'user-management-actions';
          const roleSelect = document.createElement('select');
          roleSelect.className = 'form-select text-sm p-1.5 user-role-select';
          roleSelect.disabled = isCurrentUser;

          const userRoleOption = document.createElement('option');
          userRoleOption.value = 'user';
          userRoleOption.textContent = 'User';
          userRoleOption.selected = user.role === 'user';

          const adminRoleOption = document.createElement('option');
          adminRoleOption.value = 'admin';
          adminRoleOption.textContent = 'Admin';
          adminRoleOption.selected = user.role === 'admin';

          roleSelect.appendChild(userRoleOption);
          roleSelect.appendChild(adminRoleOption);
          roleActions.appendChild(roleSelect);
          roleCell.appendChild(roleActions);

          const statusCell = document.createElement('td');
          statusCell.className = 'p-3';
          const statusActions = document.createElement('div');
          statusActions.className = 'user-management-actions';
          const statusLabel = document.createElement('label');
          statusLabel.className = 'toggle-switch';
          const statusToggle = document.createElement('input');
          statusToggle.type = 'checkbox';
          statusToggle.className = 'user-status-toggle';
          statusToggle.checked = user.status === 'active';
          statusToggle.disabled = isCurrentUser;
          const statusSlider = document.createElement('span');
          statusSlider.className = 'slider';
          statusLabel.appendChild(statusToggle);
          statusLabel.appendChild(statusSlider);

          const statusText = document.createElement('span');
          statusText.className = 'ml-2 text-sm';
          statusText.textContent = user.status === 'active' ? '활성' : '비활성';

          statusActions.appendChild(statusLabel);
          statusActions.appendChild(statusText);
          statusCell.appendChild(statusActions);

          row.appendChild(nameCell);
          row.appendChild(emailCell);
          row.appendChild(roleCell);
          row.appendChild(statusCell);
          userTableBody.appendChild(row);
        });

        container.querySelectorAll('.user-role-select, .user-status-toggle').forEach((el) => {
          el.addEventListener('change', async (e) => {
            const targetRow = e.target.closest('tr');
            const userId = targetRow ? targetRow.dataset.userId : null;
            if (!userId) {
              return;
            }

            let updateData = {};
            if (e.target.classList.contains('user-role-select')) {
              updateData.role = e.target.value;
            } else {
              updateData.status = e.target.checked ? 'active' : 'inactive';
            }
            try {
              if (!ensureAdminAccess()) {
                return;
              }
              await UserService.updateUser(userId, updateData);
              showToast('success', '사용자 정보가 업데이트되었습니다.');
              openUserManagementModal();
            } catch (error) {
              showToast('error', '업데이트에 실패했습니다.');
              console.error(error);
            }
          });
        });
      }

      function renderOptionsManagement(supportTypes) {
        const container = document.getElementById('adminOptionsTab');
        const typeRows = supportTypes
          .map(
            (type) => `
                <div class="flex justify-between items-center p-2 border-b border-border-color">
                    <span>${type.name}</span>
                    <button data-id="${type.id}" class="delete-support-type-btn text-red-500 hover:text-red-700 p-1"><i class="fas fa-trash"></i></button>
                </div>
            `,
          )
          .join('');

        container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h4 class="text-lg font-bold mb-4 text-gray-800 dark:text-white">지원 유형 관리</h4>
                        <div class="max-h-60 overflow-y-auto mb-4 border border-border-color rounded-md p-2">${typeRows || '<p class="text-center text-gray-700 dark:text-gray-300 p-4">유형이 없습니다.</p>'}</div>
                        <div class="flex flex-gap-2 mt-4">
                            <input type="text" id="newSupportTypeInput" class="form-input" placeholder="새 지원 유형 이름">
                            <button id="addSupportTypeButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg px-4 interactive-button">추가</button>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-lg font-bold mb-4 text-gray-800 dark:text-white">앱 로고 변경</h4>
                        <p class="text-sm text-gray-700 dark:text-gray-300 mb-2">앱의 로고를 변경합니다. (권장: 정사각형, 최대 1MB)</p>
                        <input type="file" id="logoUploadInput" accept="image/*" class="form-input w-full">
                    </div>
                </div>
            `;

        container.querySelector('#addSupportTypeButton').addEventListener('click', async () => {
          const input = container.querySelector('#newSupportTypeInput');
          const name = input.value.trim();
          if (!name) {
            showToast('error', '지원 유형 이름을 입력하세요.');
            return;
          }
          try {
            if (!ensureAdminAccess()) {
              return;
            }
            await addDoc(collection(db, 'settings', 'appConfig', 'supportTypes'), { name });
            showToast('success', '새로운 지원 유형이 추가되었습니다.');
            input.value = '';
            openUserManagementModal();
          } catch (error) {
            showToast('error', '추가에 실패했습니다.');
            console.error(error);
          }
        });

        container.querySelectorAll('.delete-support-type-btn').forEach((btn) => {
          btn.addEventListener('click', async (e) => {
            if (!ensureAdminAccess()) {
              return;
            }
            const typeId = e.currentTarget.dataset.id;
            if (await showConfirmModal('정말로 이 유형을 삭제하시겠습니까?')) {
              try {
                if (!ensureAdminAccess()) {
                  return;
                }
                await deleteDoc(doc(db, 'settings', 'appConfig', 'supportTypes', typeId));
                showToast('success', '지원 유형이 삭제되었습니다.');
                openUserManagementModal();
              } catch (error) {
                showToast('error', '삭제에 실패했습니다.');
                console.error(error);
              }
            }
          });
        });

        container.querySelector('#logoUploadInput').addEventListener('change', handleLogoUpload);
      }

      function renderAnnouncementManagement(announcement) {
        const container = document.getElementById('adminAnnouncementTab');
        container.innerHTML = `
                <h4 class="text-lg font-bold mb-4 text-gray-800 dark:text-white">공지사항 관리</h4>
                <div>
                    <label for="announcementMessage" class="block text-sm font-medium text-gray-800 dark:text-white mb-1">공지 내용</label>
                    <textarea id="announcementMessage" rows="4" class="form-textarea w-full">${announcement.message || ''}</textarea>
                </div>
                <div class="flex items-center gap-4 mt-4">
                     <label class="toggle-switch">
                        <input type="checkbox" id="announcementActiveToggle" ${announcement.active ? 'checked' : ''}>
                        <span class="slider"></span>
                    </label>
                    <label for="announcementActiveToggle">공지 활성화</label>
                </div>
                <div class="mt-6 text-right">
                    <button id="saveAnnouncementButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg interactive-button">공지사항 저장</button>
                </div>
            `;

        container.querySelector('#saveAnnouncementButton').addEventListener('click', async () => {
          const message = container.querySelector('#announcementMessage').value;
          const active = container.querySelector('#announcementActiveToggle').checked;
          try {
            if (!ensureAdminAccess()) {
              return;
            }
            await setDoc(doc(db, 'settings', 'announcement'), { message, active });
            showToast('success', '공지사항이 저장되었습니다.');
          } catch (error) {
            showToast('error', '저장에 실패했습니다.');
            console.error(error);
          }
        });
      }

      // --- Modal & Utility Functions ---
      function closeFullCalendarPopovers() {
        if (calendar) {
          calendar.unselect();
        }
      }

      let confirmPromiseResolve;
      function showConfirmModal(message) {
        return new Promise((resolve) => {
          confirmPromiseResolve = resolve;
          const modalContainer = document.getElementById('confirmModal');
          const modalMessage = document.getElementById('confirmMessage');
          const okButton = document.getElementById('confirmOk');
          const cancelButton = document.getElementById('confirmCancel');

          const handleOk = () => {
            closeConfirmModal(true);
          };
          const handleCancel = () => {
            closeConfirmModal(false);
          };
          okButton.onclick = handleOk;
          cancelButton.onclick = handleCancel;

          modalMessage.textContent = message;
          modalContainer.classList.remove('hidden');
          cancelButton.focus();

          const modalContent = modalContainer.querySelector('.modal-content');
          if (modalContent) {
            const modalWidth = modalContent.offsetWidth;
            const modalHeight = modalContent.offsetHeight;
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;

            const top = (windowHeight - modalHeight) / 2;
            const left = (windowWidth - modalWidth) / 2;

            modalContent.style.position = 'absolute';
            modalContent.style.top = `${top}px`;
            modalContent.style.left = `${left}px`;
            modalContent.style.transform = '';
            modalContent.style.margin = '0';
          }
        });
      }

      function closeConfirmModal(result) {
        const modalContainer = document.getElementById('confirmModal');
        modalContainer.classList.add('hidden');
        if (confirmPromiseResolve) {
          confirmPromiseResolve(result);
          confirmPromiseResolve = null;
        }
      }

      function handleGlobalEscapeKey(event) {
        if (event.key !== 'Escape') {
          return;
        }

        const visibleModals = Array.from(document.querySelectorAll('.modal-overlay:not(.hidden)'));
        if (visibleModals.length === 0) {
          return;
        }

        const topModal = visibleModals.reduce((currentTop, candidate) => {
          const currentTopZIndex =
            Number.parseInt(window.getComputedStyle(currentTop).zIndex || '0', 10) || 0;
          const candidateZIndex =
            Number.parseInt(window.getComputedStyle(candidate).zIndex || '0', 10) || 0;
          if (candidateZIndex > currentTopZIndex) {
            return candidate;
          }
          return currentTop;
        });

        if (!topModal || topModal.id === 'authModal') {
          return;
        }

        event.preventDefault();

        if (topModal.id === 'confirmModal') {
          closeConfirmModal(false);
          return;
        }

        if (topModal.id === 'workLogModal') {
          cancelEdit();
          return;
        }

        if (topModal.id === 'signupModal') {
          topModal.classList.add('hidden');
          const authModal = document.getElementById('authModal');
          authModal.classList.remove('hidden');
          const authModalContent = authModal.querySelector('.modal-content');
          if (authModalContent) {
            resetModalPosition(authModalContent);
          }
          return;
        }

        topModal.classList.add('hidden');
      }

      function showToast(type, message, duration = 4000) {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), duration);
      }

      function makeModalDraggable(modalContent) {
        if (!modalContent) {
          return;
        }
        if (modalContent.dataset.draggableBound === 'true') {
          return;
        }

        const header = modalContent.querySelector('.modal-header');
        if (!header) return;

        let isDragging = false;
        let offsetX, offsetY;

        // 터치 시작 이벤트 핸들러
        const startDrag = (e) => {
          const clientX = e.type.startsWith('touch') ? e.touches[0].clientX : e.clientX;
          const clientY = e.type.startsWith('touch') ? e.touches[0].clientY : e.clientY;

          const closeButton = header.querySelector('button');
          if (closeButton && closeButton.contains(e.target)) {
            e.stopPropagation();
            return;
          }

          isDragging = true;
          const rect = modalContent.getBoundingClientRect();
          offsetX = clientX - rect.left;
          offsetY = clientY - rect.top;
          modalContent.style.position = 'absolute';
          modalContent.style.margin = '0';

          // 터치 및 마우스 이동 이벤트 리스너 등록
          document.addEventListener('mousemove', drag);
          document.addEventListener('mouseup', stopDrag);
          document.addEventListener('touchmove', drag, { passive: false });
          document.addEventListener('touchend', stopDrag);
        };

        // 터치/마우스 이동 이벤트 핸들러
        const drag = (e) => {
          if (!isDragging) return;
          e.preventDefault();

          const clientX = e.type.startsWith('touch') ? e.touches[0].clientX : e.clientX;
          const clientY = e.type.startsWith('touch') ? e.touches[0].clientY : e.clientY;

          modalContent.style.left = `${clientX - offsetX}px`;
          modalContent.style.top = `${clientY - offsetY}px`;
        };

        // 터치/마우스 종료 이벤트 핸들러
        const stopDrag = () => {
          isDragging = false;
          document.removeEventListener('mousemove', drag);
          document.removeEventListener('mouseup', stopDrag);
          document.removeEventListener('touchmove', drag);
          document.removeEventListener('touchend', stopDrag);
        };

        // 마우스 및 터치 이벤트 리스너 추가
        header.addEventListener('mousedown', startDrag);
        header.addEventListener('touchstart', startDrag);
        modalContent.dataset.draggableBound = 'true';
      }

      function resetModalPosition(modalContent) {
        if (!modalContent) {
          return;
        }
        const modalWidth = modalContent.offsetWidth;
        const modalHeight = modalContent.offsetHeight;
        const windowWidth = window.innerWidth;
        const windowHeight = window.innerHeight;

        const top = (windowHeight - modalHeight) / 2;
        const left = (windowWidth - modalWidth) / 2;

        modalContent.style.position = 'absolute';
        modalContent.style.top = `${top}px`;
        modalContent.style.left = `${left}px`;
        modalContent.style.transform = '';
        modalContent.style.margin = '0';
      }

      // --- FullCalendar & View Toggling ---
      function initializeCalendar() {
        const calendarEl = document.getElementById('calendar');
        if (calendar) {
          calendar.destroy();
        }
        calendar = new FullCalendar.Calendar(calendarEl, {
          locale: 'ko',
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,listWeek',
          },
          initialView: 'dayGridMonth',
          navLinks: true,
          selectable: true,
          editable: false,
          dayMaxEvents: true,
          events: [],
          eventClick: function (info) {
            closeFullCalendarPopovers();
            showEventDetailModal(info.event.extendedProps);
          },
          dateClick: function (info) {
            closeFullCalendarPopovers();
            cancelEdit();
            document.getElementById('workLogModal').classList.remove('hidden');
            if (datePicker) datePicker.setDate(info.dateStr, true);
            const workLogModalContent = document.querySelector('#workLogModal .modal-content');
            if (workLogModalContent) {
              resetModalPosition(workLogModalContent);
            }
          },
          eventContent: function (arg) {
            const event = arg.event;
            const initial = getEventInitial(event.extendedProps.name);
            const isPersonalEvent =
              currentUser && event.extendedProps.submittedBy === currentUser.uid;
            const timeText =
              event.extendedProps.startTime && event.extendedProps.endTime && !isPersonalEvent
                ? getEventTimeRange(event.extendedProps.startTime, event.extendedProps.endTime)
                : '';

            let container = document.createElement('div');
            container.classList.add('flex', 'items-center', 'truncate');

            let initialEl = document.createElement('span');
            initialEl.classList.add('user-initial-icon');
            initialEl.textContent = initial;

            let titleEl = document.createElement('span');
            titleEl.textContent = event.title;
            titleEl.classList.add('flex-shrink-0');

            container.appendChild(initialEl);
            container.appendChild(titleEl);

            if (timeText) {
              let timeEl = document.createElement('span');
              timeEl.classList.add('text-xs', 'text-gray-400', 'ml-1', 'truncate');
              timeEl.textContent = timeText;
              container.appendChild(timeEl);
            }

            return { domNodes: [container] };
          },
        });
        if (!document.getElementById('calendarViewContainer').classList.contains('hidden')) {
          calendar.render();
        }
      }

      function getEventTimeRange(startTime, endTime) {
        let timeText = '';
        if (startTime && endTime) {
          const startHour = parseInt(startTime.split(':')[0]);
          const endHour = parseInt(endTime.split(':')[0]);
          let startPeriod = startHour < 12 ? '오전' : '오후';
          let endPeriod = endHour < 12 ? '오전' : '오후';

          timeText = `${startPeriod} ${startHour % 12 || 12}시 - ${endPeriod} ${endHour % 12 || 12}시`;
        } else {
          timeText = '종일';
        }

        if (startTime && parseInt(startTime.split(':')[0]) >= 18) {
          timeText = `야간 ${timeText}`;
        }

        return timeText;
      }

      function getEventInitial(name) {
        return Utils.getEventInitial(name);
      }

      function toggleView(view) {
        const listViewToggle = document.getElementById('listViewToggle');
        const calendarViewToggle = document.getElementById('calendarViewToggle');
        const listViewContainer = document.getElementById('listViewContainer');
        const calendarViewContainer = document.getElementById('calendarViewContainer');

        const setButtonState = (button, isActive) => {
          if (isActive) {
            button.classList.add(
              'bg-white',
              'dark:bg-gray-500',
              'shadow',
              'text-gray-800',
              'dark:text-white',
            );
            button.classList.remove('text-gray-600', 'dark:text-gray-300');
          } else {
            button.classList.remove(
              'bg-white',
              'dark:bg-gray-500',
              'shadow',
              'text-gray-800',
              'dark:text-white',
            );
            button.classList.add('text-gray-600', 'dark:text-gray-300');
          }
        };

        if (view === 'list') {
          listViewContainer.classList.remove('hidden');
          calendarViewContainer.classList.add('hidden');
          setButtonState(listViewToggle, true);
          setButtonState(calendarViewToggle, false);
        } else {
          listViewContainer.classList.add('hidden');
          calendarViewContainer.classList.remove('hidden');
          setButtonState(listViewToggle, false);
          setButtonState(calendarViewToggle, true);
          setTimeout(() => calendar.render(), 0);
        }
      }

      function updateCalendarEvents() {
        if (!calendar) return;
        const filteredData = getUiFilteredData();
        const calendarEvents = filteredData.map((record) => {
          const event = {
            title: record.client,
            start: record.date,
            extendedProps: record,
            backgroundColor: getEventColor(record.supportType),
            borderColor: getEventColor(record.supportType),
          };

          if (record.startTime && record.endTime) {
            event.start = `${record.date}T${record.startTime}:00`;
            event.end = `${record.date}T${record.endTime}:00`;
            event.allDay = false;
          } else {
            event.allDay = true;
          }

          return event;
        });

        calendar.getEventSources().forEach((source) => {
          source.remove();
        });
        calendar.addEventSource(calendarEvents);

        // Add Korean holidays - show as text, not background
        const currentYear = new Date().getFullYear();
        const holidays = getAllHolidays(currentYear);
        const holidayEvents = holidays.map((holiday) => ({
          title: holiday.name,
          start: holiday.date,
          allDay: true,
          backgroundColor: 'transparent',
          borderColor: 'transparent',
          textColor: '#dc2626',
          extendedProps: { ...holiday, isHoliday: true },
          display: 'list-item',
          classNames: ['holiday-event'],
        }));
        calendar.addEventSource(holidayEvents);
      }

      function getEventColor(supportType) {
        switch (supportType) {
          case '고객지원':
            return '#3498db';
          case '제안지원':
            return '#2ecc71';
          case '원격지원':
            return '#f1c40f';
          case '기타지원':
            return '#95a5a6';
          default:
            return '#4f46e5';
        }
      }

      function showEventDetailModal(record) {
        closeFullCalendarPopovers();
        const modal = document.getElementById('eventDetailModal');
        const canModify =
          currentUser && (currentUser.role === 'admin' || currentUser.uid === record.submittedBy);
        const actionButtonsHtml = canModify
          ? `
                <button id="copyEventButton" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg interactive-button">복사</button>
                <button id="editFromCalendarButton" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg interactive-button">수정</button>
                <button id="deleteFromCalendarButton" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg interactive-button">삭제</button>
            `
          : '';

        modal.innerHTML = `
                <div class="modal-content card max-w-lg">
                    <div class="modal-header">
                         <h3 id="eventDetailTitle" class="text-xl font-bold"></h3>
                         <button id="closeEventDetailModal" class="text-2xl hover:text-red-500">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="space-y-3 text-sm">
                            <div class="flex items-center">
                                <span id="eventDetailInitial" class="user-initial-icon"></span>
                                <p class="ml-2"><strong>작성자:</strong> <span id="eventDetailAuthor"></span></p>
                            </div>
                            <p><strong>장소:</strong> <span id="eventDetailPlace"></span></p>
                            <p><strong>지원 유형:</strong> <span id="eventDetailSupportType" class="font-semibold"></span></p>
                            <p><strong>지원 시간:</strong> <span id="eventDetailTimeRange"></span></p>
                            <p><strong>총 시간:</strong> <span id="eventDetailSupportHours"></span> 시간</p>
                            <div class="border-t border-border-color pt-3 mt-3">
                                <p class="font-semibold mb-1">지원 내용:</p>
                                <p id="eventDetailDescription" class="p-2 bg-gray-100 dark:bg-gray-700 rounded-md whitespace-pre-wrap"></p>
                            </div>
                        </div>
                        <div class="flex justify-end gap-2 mt-6">
                            ${actionButtonsHtml}
                        </div>
                    </div>
                </div>
            `;

        modal.querySelector('#eventDetailTitle').textContent =
          `${record.client || ''} - ${record.date || ''}`;
        modal.querySelector('#eventDetailInitial').textContent = getEventInitial(record.name);
        modal.querySelector('#eventDetailAuthor').textContent = record.name || '';
        modal.querySelector('#eventDetailPlace').textContent = record.place || '';
        const supportTypeElement = modal.querySelector('#eventDetailSupportType');
        supportTypeElement.textContent = record.supportType || '';
        supportTypeElement.style.color = getEventColor(record.supportType);
        modal.querySelector('#eventDetailTimeRange').textContent = getEventTimeRange(
          record.startTime,
          record.endTime,
        );
        modal.querySelector('#eventDetailSupportHours').textContent = record.supportHours || '';
        modal.querySelector('#eventDetailDescription').textContent = record.details || '';

        modal.classList.remove('hidden');
        const eventDetailModalContent = modal.querySelector('.modal-content');
        if (eventDetailModalContent) {
          resetModalPosition(eventDetailModalContent);
          makeModalDraggable(eventDetailModalContent);
        }

        const copyButton = modal.querySelector('#copyEventButton');
        const editButton = modal.querySelector('#editFromCalendarButton');
        const deleteButton = modal.querySelector('#deleteFromCalendarButton');
        const closeButton = modal.querySelector('#closeEventDetailModal');

        if (copyButton)
          copyButton.addEventListener('click', () => {
            modal.classList.add('hidden');
            handleCopyEvent(record);
          });
        if (editButton)
          editButton.addEventListener('click', () => {
            modal.classList.add('hidden');
            handleEdit(record.id, record);
          });
        if (deleteButton)
          deleteButton.addEventListener('click', () => {
            modal.classList.add('hidden');
            handleDelete(record.id);
          });
        if (closeButton) closeButton.addEventListener('click', () => modal.classList.add('hidden'));
      }

      function handleCopyEvent(record) {
        cancelEdit();

        const workLogModal = document.getElementById('workLogModal');
        workLogModal.classList.remove('hidden');

        const workLogForm = document.getElementById('workLogForm');

        const workLogModalContent = workLogModal.querySelector('.modal-content');
        if (workLogModalContent) {
          const originalDate = new Date(record.date);
          const newDate = new Date(
            originalDate.getFullYear(),
            originalDate.getMonth() + 1,
            originalDate.getDate(),
          );

          if (datePicker) datePicker.setDate(newDate, true);
          workLogForm.client.value = record.client;
          workLogForm.place.value = record.place;
          workLogForm.supportType.value = record.supportType;
          workLogForm.departureTime.value = record.departureTime;
          workLogForm.arrivalTime.value = record.arrivalTime;
          workLogForm.startTime.value = record.startTime;
          workLogForm.endTime.value = record.endTime;
          workLogForm.supportHours.value = record.supportHours;
          workLogForm.details.value = record.details;

          editingRecordId = null;
          workLogForm.querySelector('#submitButton').textContent = '기록 제출';
          workLogForm.querySelector('#cancelEditButton').classList.add('hidden');
          resetModalPosition(workLogModalContent);
        }

        showToast('success', `기록을 복사했습니다. 내용을 수정하여 제출하세요.`);
      }

      async function fetchAndPopulateSupportTypes() {
        const supportTypesRef = collection(AppState.db, 'settings', 'appConfig', 'supportTypes');
        const snapshot = await getDocs(query(supportTypesRef, orderBy('name')));
        const supportTypes = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
        populateSupportTypeDropdown(supportTypes);
      }

      function populateSupportTypeDropdown(supportTypes) {
        const select = document.querySelector('#workLogModal #supportType');
        select.innerHTML = '<option value="">선택하세요</option>';
        supportTypes.forEach((type) => {
          const option = document.createElement('option');
          option.value = type.name;
          option.textContent = type.name;
          select.appendChild(option);
        });
      }

      async function openTemplateModal() {
        closeFullCalendarPopovers();
        const modal = document.getElementById('templateModal');
        const workLogModal = document.getElementById('workLogModal');

        workLogModal.classList.add('hidden');

        modal.innerHTML = `<div class="modal-content card"><div class="text-center"><div class="skeleton h-8 w-48 mx-auto"></div></div></div>`;
        modal.classList.remove('hidden');
        const modalContent = modal.querySelector('.modal-content');
        if (modalContent) {
          resetModalPosition(modalContent);
        }

        try {
          const templateSnapshot = await TemplateService.fetchAll(currentUser.uid);
          const templates = templateSnapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));

          modal.innerHTML = `
                    <div class="modal-content card">
                        <div class="modal-header">
                            <h3 class="text-xl font-bold">템플릿 관리</h3>
                            <button id="closeTemplateModal" class="text-2xl hover:text-red-500">&times;</button>
                        </div>
                        <div class="modal-body">
                            <ul id="templateList" class="max-h-64 overflow-y-auto mb-4 border border-border-color rounded-md"></ul>
                            <div class="flex flex-gap-2 mt-4">
                                <input type="text" id="templateNameInput" class="form-input" placeholder="새 템플릿 이름">
                                <button id="saveTemplateButton" class="bg-green-600 text-white font-bold rounded-lg px-4 interactive-button">저장</button>
                            </div>
                        </div>
                    </div>
                `;

          const templateList = modal.querySelector('#templateList');
          if (templates.length === 0) {
            const emptyState = document.createElement('p');
            emptyState.className = 'text-center text-gray-700 dark:text-gray-300 p-4';
            emptyState.textContent = '유형이 없습니다.';
            templateList.appendChild(emptyState);
          } else {
            templates.forEach((template) => {
              const item = document.createElement('li');
              item.className =
                'flex justify-between items-center px-2 py-1.5 border-b border-border-color last:border-b-0';

              const nameElement = document.createElement('span');
              nameElement.className = 'truncate pr-2';
              nameElement.textContent = template.name || '';

              const actions = document.createElement('div');
              actions.className = 'flex items-center space-x-1';

              const applyButton = document.createElement('button');
              applyButton.dataset.id = template.id;
              applyButton.className = 'apply-template-btn text-blue-500 hover:text-blue-700 p-1';
              applyButton.title = '적용';
              applyButton.innerHTML = '<i class="fas fa-check"></i>';

              const editButton = document.createElement('button');
              editButton.dataset.id = template.id;
              editButton.className = 'edit-template-btn text-orange-500 hover:text-orange-700 p-1';
              editButton.title = '수정';
              editButton.innerHTML = '<i class="fas fa-edit"></i>';

              const deleteButton = document.createElement('button');
              deleteButton.dataset.id = template.id;
              deleteButton.className = 'delete-template-btn text-red-500 hover:text-red-700 p-1';
              deleteButton.title = '삭제';
              deleteButton.innerHTML = '<i class="fas fa-trash"></i>';

              actions.appendChild(applyButton);
              actions.appendChild(editButton);
              actions.appendChild(deleteButton);

              item.appendChild(nameElement);
              item.appendChild(actions);
              templateList.appendChild(item);
            });
          }

          const closeTemplateModalButton = modal.querySelector('#closeTemplateModal');
          if (closeTemplateModalButton) {
            closeTemplateModalButton.addEventListener('click', () => modal.classList.add('hidden'));
          }

          const saveTemplateButton = modal.querySelector('#saveTemplateButton');
          if (saveTemplateButton) {
            saveTemplateButton.addEventListener('click', saveAsTemplate);
          }

          modal.querySelectorAll('.apply-template-btn').forEach((btn) => {
            btn.addEventListener('click', (e) =>
              applyTemplate(e.currentTarget.dataset.id, templates),
            );
          });
          modal.querySelectorAll('.edit-template-btn').forEach((btn) => {
            btn.addEventListener('click', (e) =>
              editTemplate(e.currentTarget.dataset.id, templates),
            );
          });
          modal.querySelectorAll('.delete-template-btn').forEach((btn) => {
            btn.addEventListener('click', (e) => deleteTemplate(e.currentTarget.dataset.id));
          });

          const newModalContent = modal.querySelector('.modal-content');
          if (newModalContent) {
            makeModalDraggable(newModalContent);
          }
        } catch (error) {
          showToast('error', '템플릿을 불러오는 데 실패했습니다.');
          console.error('Error opening template modal:', error);
          modal.classList.add('hidden');
        }
      }

      async function saveAsTemplate(event) {
        event.preventDefault(); // 폼 제출 시 새로고침 방지
        const nameInput = document.getElementById('templateNameInput');
        const templateName = nameInput.value.trim();
        const form = document.getElementById('workLogForm');
        const templateId = form.dataset.templateId;
        const submitButton = document.getElementById('saveTemplateButton');

        if (!templateName && !templateId) {
          showToast('error', '템플릿 이름을 입력하세요.');
          return;
        }

        submitButton.disabled = true;
        submitButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>처리 중...`;

        try {
          const templateData = TemplateModel.fromForm(form, templateName).toFirestore();

          if (form.dataset.templateId) {
            await TemplateService.save(currentUser.uid, form.dataset.templateId, templateData);
            showToast('success', `'${templateData.name}' 템플릿이 수정되었습니다.`);
          } else {
            await TemplateService.save(currentUser.uid, null, templateData);
            showToast('success', `템플릿 '${templateData.name}'이(가) 저장되었습니다.`);
          }
          form.removeAttribute('data-template-id');
          form.removeAttribute('data-template-name');

          openTemplateModal();
        } catch (e) {
          showToast('error', '템플릿 저장/수정에 실패했습니다.');
          console.error(e);
        } finally {
          submitButton.disabled = false;
          submitButton.innerHTML = '저장';
        }
      }

      function editTemplate(templateId, templates) {
        closeFullCalendarPopovers();
        const template = templates.find((t) => t.id === templateId);
        if (template) {
          const workLogModal = document.getElementById('workLogModal');
          const workLogForm = document.getElementById('workLogForm');
          const templateModal = document.getElementById('templateModal');

          workLogForm.dataset.templateId = templateId;
          workLogForm.dataset.templateName = template.name;

          workLogForm.client.value = template.client;
          workLogForm.place.value = template.place;
          workLogForm.supportType.value = template.supportType;
          workLogForm.details.value = template.details;

          clearTimes();

          workLogForm.querySelector('#submitButton').textContent = '템플릿 수정';
          workLogForm.querySelector('#cancelEditButton').classList.remove('hidden');

          workLogForm.querySelector('#clearTimesButton').classList.add('hidden');

          templateModal.classList.add('hidden');
          workLogModal.classList.remove('hidden');

          showToast('info', `'${template.name}' 템플릿 수정 모드입니다.`);

          const workLogModalContent = workLogModal.querySelector('.modal-content');
          if (workLogModalContent) {
            resetModalPosition(workLogModalContent);
            makeModalDraggable(workLogModalContent);
          }
        }
      }

      function applyTemplate(templateId, templates) {
        closeFullCalendarPopovers();
        const template = templates.find((t) => t.id === templateId);
        if (template) {
          const form = document.getElementById('workLogModal').querySelector('form');
          const templateModal = document.getElementById('templateModal');

          form.removeAttribute('data-template-id');
          form.removeAttribute('data-template-name');
          editingRecordId = null;
          form.querySelector('#submitButton').textContent = '기록 제출';
          form.querySelector('#cancelEditButton').classList.add('hidden');
          form.querySelector('#clearTimesButton').classList.remove('hidden');

          form.client.value = template.client;
          form.place.value = template.place;
          form.supportType.value = template.supportType;
          form.details.value = template.details;

          if (datePicker) datePicker.setDate('today', true);
          clearTimes();

          templateModal.classList.add('hidden');

          const workLogModalContent = document.querySelector('#workLogModal .modal-content');
          if (workLogModalContent) {
            document.getElementById('workLogModal').classList.remove('hidden');
            resetModalPosition(workLogModalContent);
          }

          showToast('success', `'${template.name}' 템플릿을 적용했습니다.`);
        }
      }

      async function deleteTemplate(templateId) {
        if (await showConfirmModal('정말로 이 템플릿을 삭제하시겠습니까?')) {
          try {
            await TemplateService.delete(currentUser.uid, templateId);
            showToast('success', '템플릿이 삭제되었습니다.');
            openTemplateModal();
          } catch (e) {
            showToast('error', '템플릿 삭제에 실패했습니다.');
            console.error(e);
          }
        }
      }

      const ModalManager = {
        resetPosition: resetModalPosition,
        makeDraggable: makeModalDraggable,
        closeCalendarPopovers: closeFullCalendarPopovers,
      };

      const CalendarManager = {
        initialize: initializeCalendar,
        updateEvents: updateCalendarEvents,
        toggleView,
      };

      const DashboardManager = {
        update: updateDashboard,
        switch: switchDashboard,
        renderCharts: renderDashboardCharts,
      };

      // 6) Main App Initializer
      class App {
        constructor(firebaseConfig) {
          this.firebaseConfig = firebaseConfig;
        }

        initFirebase() {
          const firebaseApp = initializeApp(this.firebaseConfig);
          AppState.db = getFirestore(firebaseApp);
          AppState.auth = getAuth(firebaseApp);
        }

        initAuthViewState() {
          const authModalContent = document.querySelector('#authModal .modal-content');
          if (authModalContent) {
            ModalManager.resetPosition(authModalContent);
            ModalManager.makeDraggable(authModalContent);
          }
          const signupModalContent = document.querySelector('#signupModal .modal-content');
          if (signupModalContent) {
            ModalManager.resetPosition(signupModalContent);
            ModalManager.makeDraggable(signupModalContent);
          }
          const workLogModalContent = document.querySelector('#workLogModal .modal-content');
          if (workLogModalContent) {
            ModalManager.makeDraggable(workLogModalContent);
          }
        }

        bindAuthState() {
          AuthService.watchAuthState((user) => {
            const authModal = document.getElementById('authModal');
            const signupModal = document.getElementById('signupModal');
            const appContainer = document.getElementById('appContainer');

            clearPrivateListeners();
            this.initAuthViewState();

            if (user) {
              userListenerUnsubscribe = UserService.watchUser(
                user.uid,
                (docSnap) => {
                  if (docSnap.exists()) {
                    const userData = docSnap.data();
                    if (userData.status === 'inactive') {
                      showToast('error', '비활성화된 계정입니다. 관리자에게 문의하세요.');
                      handleLogout();
                      return;
                    }

                    currentUser = { uid: user.uid, email: user.email, ...userData };

                    // 병렬로 UI 설정 및 데이터 로딩
                    Promise.all([
                      new Promise((resolve) => {
                        setupUI();
                        resolve();
                      }),
                      new Promise((resolve) => {
                        if (!appEventListenersAttached) {
                          setupAppEventListeners();
                        }
                        resolve();
                      }),
                    ]).then(() => {
                      setupFirestoreListeners();
                      appContainer.classList.remove('hidden');
                      authModal.classList.add('hidden');
                      signupModal.classList.add('hidden');
                    });
                  } else {
                    const displayName = user.email.split('@')[0];
                    const newUser = new UserModel({
                      uid: user.uid,
                      email: user.email,
                      displayName,
                      role: 'user',
                      status: 'active',
                      createdAt: serverTimestamp(),
                      lastLogin: serverTimestamp(),
                    });

                    UserService.upsertUser(user.uid, newUser.toFirestore()).then(() => {
                      currentUser = { uid: user.uid, email: user.email, ...newUser.toFirestore() };

                      // 병렬로 UI 설정 및 데이터 로딩
                      Promise.all([
                        new Promise((resolve) => {
                          setupUI();
                          resolve();
                        }),
                        new Promise((resolve) => {
                          setupAppEventListeners();
                          resolve();
                        }),
                      ]).then(() => {
                        setupFirestoreListeners();
                        appContainer.classList.remove('hidden');
                        authModal.classList.add('hidden');
                        signupModal.classList.add('hidden');
                      });
                    });
                  }
                },
                (error) => {
                  console.error('Error listening to user document:', error);
                  showToast('error', '사용자 정보를 불러오는 데 실패했습니다.');
                  handleLogout();
                },
              );
            } else {
              currentUser = null;
              allRecords = [];
              if (calendar) calendar.removeAllEvents();
              appContainer.classList.add('hidden');
              authModal.classList.remove('hidden');
              signupModal.classList.add('hidden');
            }
          });
        }

        start() {
          this.initFirebase();
          setupGlobalEventListeners();
          setupPublicListeners();
          this.bindAuthState();
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        const firebaseConfig = {
          apiKey: 'AIzaSyCIb844beb3XzyxeGNrwPSJvSS5dWCMst8',
          authDomain: 'intruevine-c6933.firebaseapp.com',
          projectId: 'intruevine-c6933',
          storageBucket: 'intruevine-c6933.appspot.com',
          messagingSenderId: '183011672834',
          appId: '1:183011672834:web:6ff1376919cc2bf427781b',
        };
        new App(firebaseConfig).start();
      });
    </script>
  </body>
</html>
